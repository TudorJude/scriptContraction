function checkCarDataValidity(d,g){if(void 0==d.CustomData){try{var a={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemInstanceId,Data:a});a={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemInstanceId,Data:a});for(var c=0,f=0;f<g.Catalog.length;f++)if(g.Catalog[f].ItemId==d.ItemId){var e=
JSON.parse(g.Catalog[f].CustomData),c=parseInt(e.basePr);break}a={PlatesId:"0",WindshieldId:"0",Pr:c};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemInstanceId,Data:a})}catch(k){return"PlayFabError"}return{CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",Pr:c}}return"OK"}function generateFailObj(d){return{Result:"Failed",Message:d}}
function generateErrObj(d){return{Result:"Error",Message:d}}
function CheckMaintenanceAndVersion(d){var g=!1,a="A.0.0.1";void 0!=d&&(g=d.debug,a=d.cVersion);if(void 0==a)return"update";d=server.GetTitleData({Key:["Maintenance","MinimumGameVersionActual_IOS","MinimumGameVersionActual"]});var c=d.Data.MinimumGameVersionActual,a=a.split(".");if(4!=a.length)return"maintenance";"ios"==a[0]&&(c=d.Data.MinimumGameVersionActual_IOS);if(void 0==c)return"maintenance";for(var f=!1,c=c.split("."),e=0;3>e;e++){var k=0;a.length>e+1&&(k=Number(a[e+1]));var b=0;c.length>e&&
(b=Number(c[e]));if(k<b){f=!0;break}}return 1==f?"update":1==g?"OK":d.Data.Maintenance?"false"==d.Data.Maintenance?"OK":"maintenance":"maintenance"}function generateMaintenanceOrUpdateObj(d){return"maintenance"==d?{Result:"Maintenance",Message:"Servers are temporarily offline"}:{Result:"Update",Message:"Game needs to be updated"}}function generateInventoryChange(d,g){return{Result:"OK",Message:d,InventoryChange:g}}
function checkBalance(d,g,a,c){if("SC"==d){if(a<g)return generateFailObj("NotEnoughSC")}else if(c<g)return generateFailObj("NotEnoughHC");return"OK"}
function calculateLeague(d){var g=server.GetTitleData({Keys:["LeagueSubdivisions","SubdivisionTrophyRanges"]});if(void 0==g.Data.LeagueSubdivisions||void 0==g.Data.SubdivisionTrophyRanges)return 1;for(var a=JSON.parse(g.Data.LeagueSubdivisions).leagues,g=JSON.parse(g.Data.SubdivisionTrophyRanges).subdivisions,c=0;c<a.length;c++)if(!(Number(d)>Number(g[a[c]])))return c}
function recalculateCarPr(d,g,a,c){var f=0,e;e=void 0===a?server.GetCatalogItems({CatalogVersion:"CarCards"}):a;for(a=0;a<e.Catalog.length;a++)if(e.Catalog[a].ItemId==g){f=JSON.parse(e.Catalog[a].CustomData);f=parseInt(f.basePr)+getObjectValueFromLevel(f,"prPerLvl",d.CarLvl);break}c=void 0===c?server.GetCatalogItems({CatalogVersion:"PartCards"}):c;d={Exhaust:d.ExhaustLvl,Engine:d.EngineLvl,Gearbox:d.GearboxLvl,Suspension:d.SuspensionLvl,Tires:d.TiresLvl,Turbo:d.TurboLvl};for(a=0;a<c.Catalog.length;a++)g=
JSON.parse(c.Catalog[a].CustomData),f+=getObjectValueFromLevel(g,"prPerLvl",Number(d[c.Catalog[a].ItemId]));return f}
function GenerateBlackMarket(d){var g=1,a=server.GetPlayerStatistics({PlayFabId:d,StatisticNames:["League"]});0!=a.Statistics.length&&(g=a.Statistics[0].Value.toString());0>=Number(g)&&(g=1);for(var c=server.GetCatalogItems({CatalogVersion:"PartCards"}),a=server.GetTitleData({PlayFabId:d,Keys:["BlackMarketResetMinutes","BlackMarketRarityBias"]}),f=JSON.parse(a.Data.BlackMarketRarityBias),e,k=[],b=[],h=[],l=0;l<c.Catalog.length;l++){e=JSON.parse(c.Catalog[l].CustomData);if(void 0==e)return generateErrObj("Part card "+
c.Catalog[l].ItemId+" has no custom data.");0==e.rarity&&k.push(c.Catalog[l].ItemId+"_"+e.BMCurrType+"_"+e.BMbasePrice+"_0_"+e.BMpriceIncrPerBuy);1==e.rarity&&b.push(c.Catalog[l].ItemId+"_"+e.BMCurrType+"_"+e.BMbasePrice+"_0_"+e.BMpriceIncrPerBuy);2==e.rarity&&h.push(c.Catalog[l].ItemId+"_"+e.BMCurrType+"_"+e.BMbasePrice+"_0_"+e.BMpriceIncrPerBuy)}c={};c.BMTime=(new Date).getTime();l=Math.floor(Math.random()*k.length);c.BMItem0=k[l];2<=k.length&&k.splice(l,1);Math.floor(100*Math.random())<Number(f.parts[2])?
k=h:(l=Number(f.parts[0])+Number(f.parts[1]),Math.floor(Math.random()*l)>=Number(f.parts[0])&&(k=b));c.BMItem1=k[Math.floor(Math.random()*k.length)];e=server.GetCatalogItems({CatalogVersion:"CarCards"});for(var m,k=[],b=[],h=[],l=0;l<e.Catalog.length;l++){m=JSON.parse(e.Catalog[l].CustomData);if(void 0==m)return generateErrObj("Car card "+e.Catalog[l].ItemId+" has no custom data.");Number(m.unlockedAtRank)>=Number(g)+1||("0"==m.rarity&&k.push(e.Catalog[l].ItemId+"_"+m.BMCurrType+"_"+m.BMbasePrice+
"_0_"+m.BMpriceIncrPerBuy),"1"==m.rarity&&b.push(e.Catalog[l].ItemId+"_"+m.BMCurrType+"_"+m.BMbasePrice+"_0_"+m.BMpriceIncrPerBuy),"2"==m.rarity&&h.push(e.Catalog[l].ItemId+"_"+m.BMCurrType+"_"+m.BMbasePrice+"_0_"+m.BMpriceIncrPerBuy))}g=Math.floor(Math.random()*k.length);c.BMItem2=k[g];2<=k.length&&k.splice(g,1);0>=b.length&&(0>=h.length?h=b=k:b=h);0>=h.length&&(h=b);Math.floor(100*Math.random())<Number(f.cars[2])?k=h:(l=Number(f.cars[0])+Number(f.cars[1]),Math.floor(Math.random()*l)>=Number(f.cars[0])&&
(k=b));g=Math.floor(Math.random()*k.length);c.BMItem3=k[g];server.UpdateUserInternalData({PlayFabId:d,Data:c});c.BMTime=60*parseInt(a.Data.BlackMarketResetMinutes);return c}function GetCurrentBlackMarket(d,g){var a={},c=new Date,f=[];f.push("BlackMarketResetMinutes");f=server.GetTitleData({PlayFabId:d,Keys:f});a.BMTime=60*parseInt(f.Data.BlackMarketResetMinutes)-Math.floor((c.getTime()-g.Data.BMTime.Value)/1E3);for(c=0;4>c;c++)a["BMItem"+c]=g.Data["BMItem"+c].Value;return a}
function GetValueFromStatistics(d,g,a){for(var c,f=0;f<d.length;f++)d[f].StatisticName===g&&(c=d[f]);log.debug("Stat with name statisticsName: "+g+" is "+c);return void 0===c?void 0!==a?a:0:Number(c.Value)}function getCatalogItem(d,g){for(var a=server.GetCatalogItems({CatalogVersion:d}),c=0;c<a.Catalog.length;c++)if(a.Catalog[c].ItemId===g)return a.Catalog[c]}
function getObjectValueFromLevel(d,g,a,c){c||(c=0);if(!d[g]||!d[g].length)return c;var f=Number(d[g].length);a>=f&&(a=f-1);return Number(d[g][a])||c}
handlers.buyChest=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);a=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(d.curr,d.cost,a.VirtualCurrency.SC,a.VirtualCurrency.HC))return generateFailObj("not enough money");if(0<d.cost){var a=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:d.curr,Amount:d.cost}),c={};c[a.VirtualCurrency]=a.Balance;return generateInventoryChange("ChestBought",{VirtualCurrency:c})}return generateInventoryChange("ChestBought",
{})};
handlers.endGame=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);var c="01",f,e="0";"rWin"==d.outcome&&(e="1");a=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});0!=a.Statistics.length&&(f=a.Statistics[0].Value.toString(),c=Number(f).toString(2));var a=0,k;k=Array(c.length);for(var b=0;b<k.length-1;b++)k[b]=c[b];k[k.length-1]=e;c=k;k=c.length;for(var h=e=0,b=0;b<c.length;b++)"1"==c[b]?(a++,h++):(h>e&&(e=h),h=0);
k=Math.round(a/k*100);var h=server.GetTitleData({Key:["LeagueSubdivisions","SubdivisionTrophyRanges"]}),a=0,l,b=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]});0!=b.Statistics.length&&(a=b.Statistics[0].Value,log.debug("getting trophy count "+b.Statistics[0].Value));l=a=Number(a);b=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:["trophyLose","trophyWin"]});b=void 0==b.Data.trophyLose||void 0==b.Data.trophyWin?45:Number(b.Data.trophyLose.Value)+Number(b.Data.trophyWin.Value);
"rWin"==d.outcome&&(a+=b);var m=JSON.parse(d.recordingHeader),b=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["Wins","TotalGamesCompleted","LongestWinStreak","BestDriftScore"]}).Statistics,n=GetValueFromStatistics(b,"TotalGamesCompleted",0),n=Number(n)+1,q=GetValueFromStatistics(b,"Wins",0);"rWin"==d.outcome&&(q=Number(q)+1);var y=GetValueFromStatistics(b,"LongestWinStreak",0);e>y&&(y=e);var w=GetValueFromStatistics(b,"BestDriftScore",0);Number(m.Score)>w&&(w=Number(m.Score));
e=calculateLeague(a);for(b=f=0;b<c.length;b++)"1"==c[b]&&(f+=Math.pow(2,b));b=[];b.push({StatisticName:"WinLoss",Version:"0",Value:f});c={StatisticName:"TrophyCount",Version:"0",Value:a};b.push(c);c={StatisticName:"League",Version:"0",Value:e};b.push(c);c={StatisticName:"Wins",Version:"0",Value:q};b.push(c);c={StatisticName:"TotalGamesCompleted",Version:"0",Value:n};b.push(c);c={StatisticName:"LongestWinStreak",Version:"0",Value:y};b.push(c);c={StatisticName:"BestDriftScore",Version:"0",Value:w};
b.push(c);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:b});if(10>=Number(m.Score)){var t={TrophyCount:a,League:e};return{Result:t}}c=JSON.parse(h.Data.SubdivisionTrophyRanges);for(b=0;b<c.subdivisions.length;b++)if(l<c.subdivisions[b]){t=b;break}b=[];b.push({Key:d.envIndex+"_"+d.courseIndex+"_RecPos",Value:d.recordingPos});b.push({Key:d.envIndex+"_"+d.courseIndex+"_RecRot",Value:d.recordingRot});b.push({Key:d.envIndex+"_"+d.courseIndex+"_RecHeader",Value:d.recordingHeader});
server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:b});b=server.GetTitleInternalData({Key:"RecSubDivision"+t}).Data["RecSubDivision"+t];if(void 0==b)c=[],k={wl:k,e:d.envIndex,c:d.courseIndex,uId:currentPlayerId},c.push(k);else{c=JSON.parse(b);k={wl:k,e:d.envIndex,c:d.courseIndex,uId:currentPlayerId};h=!1;for(b=l=0;b<c.length;b++)c[b].uId==currentPlayerId&&l++;if(2<l)return t={TrophyCount:a,League:e},{Result:t};for(b=0;b<c.length;b++)if(c[b].e==d.envIndex&&c[b].c==d.courseIndex){h=!0;c[b]=
k;if(1==c.length)break;if(0<b)if(c[b].wl>c[b-1].wl){if(b==c.length-1)break;for(l=b+1;l<c.length;l++)if(c[l-1].wl>c[l].wl)m=c[l],c[l]=c[l-1],c[l-1]=m;else break}else for(l=b-1;0<=l;l--)if(c[l+1].wl<c[l].wl)m=c[l],c[l]=c[l+1],c[l+1]=m;else break;else for(l=b+1;l<c.length;l++)if(c[l-1].wl>c[l].wl)m=c[l],c[l]=c[l-1],c[l-1]=m;else break}0==h&&c.push(k)}b=JSON.stringify(c);server.SetTitleInternalData({Key:"RecSubDivision"+t,Value:b});t={TrophyCount:a,League:e};return{Result:t}};
function UpdateExperience(d,g,a,c,f,e){d=JSON.parse(getCatalogItem(d,g).CustomData)[a];g=JSON.parse(getCatalogItem("Balancing","BalancingItem").CustomData).LevelThresholds;g=g[g.length-1];e=e||server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["Experience"]}).Statistics;e=GetValueFromStatistics(e,"Experience",0);if(e>=g)return g;if(isNaN(Number(d)))a=Number(d.length),c>=a&&(c=a-1),c=Number(d[c]);else if(c=Number(d),0===c)return e;e=Math.min(e+c,g);if(!f)return e;server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,
Statistics:[{StatisticName:"Experience",Version:"0",Value:e}]});return e}handlers.getServerTime=function(d,g){return{time:new Date}};
handlers.initServerData=function(d){d=[];var g={StatisticName:"TrophyCount",Version:"0",Value:"0"};d.push(g);g={StatisticName:"League",Version:"0",Value:"0"};d.push(g);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:d});d=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:["Decals","PaintJobs","Plates","Rims","WindshieldText"]});for(var g={0:"Owned"},a=0;a<d.ItemGrantResults.length;a++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:d.ItemGrantResults[a].ItemInstanceId,Data:g});d=[];d.push("FordFocus");d=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:d});g={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g});g={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g});g={PlatesId:"0",WindshieldId:"0",Pr:"10"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g});g=[];g.push("Engine");g=server.GrantItemsToUser({CatalogVersion:"PartCards",PlayFabId:currentPlayerId,ItemIds:g});server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.ItemGrantResults[0].ItemInstanceId,Data:{Amount:"5"}});g={CarLvl:"1",EngineLvl:"0",
ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g})};
handlers.openChest=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);if(0<d.levelUpRewardIndex){var c=0,a=server.GetUserReadOnlyData({PlayFabId:currentPlayerId,Keys:["LastLevelReward"]}),f={LastLevelReward:0};void 0==a.Data.LastLevelReward?server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:f}):c=a.Data.LastLevelReward.Value;var e=JSON.parse(getCatalogItem("Balancing","BalancingItem").CustomData).LevelThresholds,a=server.GetPlayerStatistics({PlayFabId:currentPlayerId,
StatisticNames:["Experience"]}).Statistics,k=GetValueFromStatistics(a,"Experience",0);0==k&&(a=[],a.push({StatisticName:"Experience",Version:"0",Value:0}),server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:a}));for(var b=e.length,a=0;a<e.length;a++)if(!(k>=e[a])){b=a;break}if(Number(d.levelUpRewardIndex)<=Number(b))c=Number(d.levelUpRewardIndex),f.LastLevelReward=c,server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:f}),a=""+c,a="000".substring(0,3-a.length)+a,server.GrantItemsToUser({CatalogVersion:"LevelUpRewards",
PlayFabId:currentPlayerId,ItemIds:a});else return generateFailObj("already got reward for level: "+c)}c=server.GetUserInventory({PlayFabId:currentPlayerId});if(0<d.currCost){if("OK"!=checkBalance(d.currType,d.currCost,c.VirtualCurrency.SC,c.VirtualCurrency.HC))return generateFailObj("not enough money");server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:d.currType,Amount:d.currCost})}for(var h in d.currencyReq)0<d.currencyReq[h]&&server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:h,Amount:d.currencyReq[h]});for(h in d.carCardsRequest)if(d.carCardsRequest.hasOwnProperty(h)){f=!1;for(a=0;a<c.Inventory.length;a++)if(c.Inventory[a].ItemId==h&&"CarCards"==c.Inventory[a].CatalogVersion){f=void 0==c.Inventory[a].CustomData?Number(d.carCardsRequest[h]):void 0==c.Inventory[a].CustomData.Amount?Number(d.carCardsRequest[h]):isNaN(Number(c.Inventory[a].CustomData.Amount))?Number(d.carCardsRequest[h]):Number(c.Inventory[a].CustomData.Amount)+Number(d.carCardsRequest[h]);
f={Amount:f};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.Inventory[a].ItemInstanceId,Data:f});f=!0;break}0==f&&(a=[h],a=server.GrantItemsToUser({CatalogVersion:"CarCards",PlayFabId:currentPlayerId,ItemIds:a}),f={Amount:d.carCardsRequest[h]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.ItemGrantResults[0].ItemInstanceId,Data:f}))}for(h in d.partCardsRequest)if(d.partCardsRequest.hasOwnProperty(h)){f=!1;for(a=0;a<c.Inventory.length;a++)if(c.Inventory[a].ItemId==
h&&"PartCards"==c.Inventory[a].CatalogVersion){f=void 0==c.Inventory[a].CustomData?Number(d.partCardsRequest[h]):void 0==c.Inventory[a].CustomData.Amount?Number(d.partCardsRequest[h]):isNaN(Number(c.Inventory[a].CustomData.Amount))?Number(d.partCardsRequest[h]):Number(c.Inventory[a].CustomData.Amount)+Number(d.partCardsRequest[h]);f={Amount:f};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.Inventory[a].ItemInstanceId,Data:f});f=!0;break}0==f&&(a=[h],a=server.GrantItemsToUser({CatalogVersion:"PartCards",
PlayFabId:currentPlayerId,ItemIds:a}),f={Amount:d.partCardsRequest[h]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.ItemGrantResults[0].ItemInstanceId,Data:f}))}h=server.GetUserInventory({PlayFabId:currentPlayerId});d.chestId&&0>=d.levelUpRewardIndex&&(a=UpdateExperience("Chests",d.chestId,"xpGain",0,!0),h.Experience=a);return generateInventoryChange("InventoryUpdated",h)};
handlers.purchaseBMItem=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);if(0>d.itemId||3<d.itemId)return generateFailObj("invalid item index");a=[];a.push("BMItem"+d.itemId);var a=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:a}),c=server.GetUserInventory({PlayFabId:currentPlayerId}),a=a.Data["BMItem"+d.itemId].Value.split("_"),f=c.VirtualCurrency[a[1]];5!=a.length&&generateErrObj("User Black Market corrupted. Try again tomorrow");
var e;e=2>d.itemId?"PartCards":"CarCards";var k=parseInt(a[2])+parseInt(a[3])*parseInt(a[4]),f=checkBalance(a[1],k,f,f);if("OK"!=f)return f;for(var b,h,f=0;f<c.Inventory.length;f++)if(c.Inventory[f].ItemId==a[0]&&c.Inventory[f].CatalogVersion==e){b=c.Inventory[f].ItemInstanceId;void 0===c.Inventory[f].CustomData?h={Amount:1}:void 0===c.Inventory[f].CustomData.Amount?h={Amount:1}:(h=Number(c.Inventory[f].CustomData.Amount)+1,isNaN(h)&&(h=1),h={Amount:h});server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:b,Data:h});break}void 0===b&&(b=[],b.push(a[0]),b=server.GrantItemsToUser({CatalogVersion:e,PlayFabId:currentPlayerId,ItemIds:b}).ItemGrantResults[0].ItemInstanceId,void 0===b?generateErrObj("grantRequest denied"):(h={Amount:1},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b,Data:h})));b=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a[1],Amount:k});k=a[0]+"_"+a[1]+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];c={};c["BMItem"+
d.itemId]=k;server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:c});h=[{ItemId:a[0],CatalogVersion:e,CustomData:h}];e={};e[b.VirtualCurrency]=b.Balance;a=d.itemId+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];f={Inventory:h,VirtualCurrency:e};return{Result:"OK",Message:"InventoryUpdate",InventoryChange:f,BMItemChange:a}};
handlers.purchaseItems=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);var c=server.GetUserInventory({PlayFabId:currentPlayerId}),f=c.VirtualCurrency.SC,e=c.VirtualCurrency.HC;switch(d.purchaseType){case "carUpgrade":return upgradeCar(d,c,f,e);case "partUpgrade":return upgradePart(d,c,f,e);case "custPurchase":for(var k=server.GetCatalogItems({CatalogVersion:"Customization"}),b,h=0,a="SC",l=0;l<k.Catalog.length;l++)if(k.Catalog[l].ItemId==d.custId){b=
k.Catalog[l];cardInfo=JSON.parse(k.Catalog[l].CustomData);h=d.custVal+",Cost";a=cardInfo[d.custVal+",Curr"];h=cardInfo[h];e=checkBalance(a,h,f,e);if("OK"!=e)return e;break}if(void 0==b)return generateErrObj("Customization does not exist in catalog.");for(var m,n,l=0;l<c.Inventory.length;l++)if(c.Inventory[l].ItemId==d.custId){m=c.Inventory[l];n=c.Inventory[l].ItemInstanceId;if(void 0!=m.CustomData&&String(d.custVal)in m.CustomData)return generateFailObj("User already has this customization.");break}if(void 0==
m){log.info("user doesn't have customization category. Granting ... ");e=[];e.push(d.custId);e=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:e});if(0==e.ItemGrantResults[0].Result)return generateErrObj("something went wrong while granting user customization class object.");n=e.ItemGrantResults[0].ItemInstanceId}e={};e[String(d.custVal)]="Owned";server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:n,Data:e});e=[{ItemId:d.custId,
CatalogVersion:"Customization",CustomData:e}];0<h?(a=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a,Amount:h}),h={},h[a.VirtualCurrency]=a.Balance,l={Inventory:e,VirtualCurrency:h}):l={Inventory:e};return generateInventoryChange("InventoryUpdateNewCustomization",l);case "softCurrencyPurchase":a=server.GetCatalogItems({CatalogVersion:"SoftCurrencyStore"});h=!1;for(l=n=0;l<a.Catalog.length;l++)if(a.Catalog[l].ItemId==d.packId){n=a.Catalog[l].VirtualCurrencyPrices.HC;
cardInfo=JSON.parse(a.Catalog[l].CustomData);h=!0;break}if(0==h)return generateErrObj("pack with ID: "+d.packId+" not found in catalog.");if(0>=n)return generateErrObj("pack with ID: "+d.packId+" shouldn't have negative cost.");if(n>e)return generateFailObj("Not enough HC.");a=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"HC",Amount:n});e=server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"SC",Amount:cardInfo.quantity});h={};h[e.VirtualCurrency]=
e.Balance;h[a.VirtualCurrency]=a.Balance;return generateInventoryChange("SoftCurrencyPurchased",{VirtualCurrency:h});default:log.debug("invalid purchase parameter")}};handlers.requestCurrency=function(d){d=CheckMaintenanceAndVersion(d);return"OK"!=d?generateMaintenanceOrUpdateObj(d):{VirtualCurrency:server.GetUserInventory({PlayFabId:currentPlayerId}).VirtualCurrency}};
handlers.requestInventory=function(d){d=server.GetUserInventory({PlayFabId:currentPlayerId});for(var g=server.GetCatalogItems({CatalogVersion:"CarCards"}),a=server.GetCatalogItems({CatalogVersion:"PartCards"}),c=!1,f=0;f<d.Inventory.length;f++)if("CarsProgress"==d.Inventory[f].CatalogVersion){var c=!0,e=checkCarDataValidity(d.Inventory[f],g);if("PlayFabError"==e||void 0===e)return generateErrObj("PlayfabError");"OK"==e?log.debug("Data for "+d.Inventory[f].ItemId+" OK"):d.Inventory[f].CustomData=e;
d.Inventory[f].CustomData.Pr=recalculateCarPr(d.Inventory[f].CustomData,d.Inventory[f].ItemId,g,a);e={};e.Pr=d.Inventory[f].CustomData.Pr;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.Inventory[f].ItemInstanceId,Data:e})}return!1===c?(d=[],d.push("FordFocus"),d=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:d}),g={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g}),g={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g}),g={PlatesId:"0",WindshieldId:"0",Pr:"10"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:g}),generateErrObj("UserHasNoCars ... reiniting")):d};
handlers.retrieveBlackMarket=function(d,g){var a=CheckMaintenanceAndVersion(d);if(!0===d.reset&&"OK"!=a)return generateMaintenanceOrUpdateObj(a);var c=[];c.push("BMTime");for(var f=0;4>f;f++)c.push("BMItem"+f);f=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:c});if(void 0===f.Data.BMTime)return GenerateBlackMarket(currentPlayerId);var c=new Date,e=[];e.push("BlackMarketResetMinutes");e=server.GetTitleData({PlayFabId:currentPlayerId,Keys:e});if(!0===d.reset){a="HC";f=200;c=server.GetTitleData({Keys:["BlackMarketResetCost"]});
void 0!==c.Data.BlackMarketResetCost&&(f=c.Data.BlackMarketResetCost.split("_"),a=f[0],f=Number(f[1]));if(0<f){c=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(a,f,c.VirtualCurrency.SC,c.VirtualCurrency.HC))return generateFailObj("not enough money");f=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a,Amount:f});a=GenerateBlackMarket(currentPlayerId);c={};c[f.VirtualCurrency]=f.Balance;f={VirtualCurrency:c};a.InventoryChange=f;return a}return GenerateBlackMarket(currentPlayerId)}return c.getTime()-
parseInt(f.Data.BMTime.Value)>6E4*parseInt(e.Data.BlackMarketResetMinutes)?("OK"!=a&&GetCurrentBlackMarket(currentPlayerId,f),GenerateBlackMarket(currentPlayerId)):GetCurrentBlackMarket(currentPlayerId,f)};
handlers.rewardUsers=function(d,g){var a=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["Experience","TrophyCount"]}).Statistics,c=GetValueFromStatistics(a,"Experience",0),a=GetValueFromStatistics(a,"TrophyCount",0),f=0;0>=c&&(a=Number(a)/3E3,f=Number(Math.floor(800*a)));c=Number(c)+f;server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:[{StatisticName:"Experience",Version:"0",Value:c}]});return c};
handlers.startGame=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);var a="10",c,f=50,e,k=0;e=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});if(0!=e.Statistics.length){c=e.Statistics[0].Value.toString();a=Number(c).toString(2);e=a.length;for(var b=1;b<a.length;b++)"1"==a[b]&&k++;f=Math.round(k/e*100)}a+="0";if(20<a.length){k=Array(20);a=a.slice(2);k[0]="1";for(b=0;b<a.length;b++)k[b+1]=a[b];a=k}var h=server.GetTitleData({Key:["LeagueSubdivisions",
"SubdivisionTrophyRanges","TrophyGainRange","TrophyLoseRange","SubdivisionPrRanges"]}),k=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TotalGames"]}).Statistics,k=GetValueFromStatistics(k,"TotalGames",0),k=Number(k)+1,l=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]});e=0;0!=l.Statistics.length&&(e=l.Statistics[0].Value);e=Number(e);var m=JSON.parse(h.Data.SubdivisionTrophyRanges);c=JSON.parse(h.Data.LeagueSubdivisions);for(var n=JSON.parse(h.Data.SubdivisionPrRanges),
q=43,y=43,w=h.Data.TrophyGainRange.split("_"),t=h.Data.TrophyLoseRange.split("_"),l=Number(w[0]),h=Number(w[1]),w=Number(t[0]),t=Number(t[1]),b=0;b<m.subdivisions.length;b++)if(e<Number(m.subdivisions[b])){q=b;b<m.subdivisions.length-1&&(y=b+1);break}y=Number(m.subdivisions[y])-Number(m.subdivisions[q]);0>=y&&(y=400);var v=server.GetTitleInternalData({Keys:"RecSubDivision"+q}).Data["RecSubDivision"+q],r=!1;void 0==v&&(r=!0);var z,x=q="noop",u,b=server.GetUserInternalData({PlayFabId:currentPlayerId,
Keys:["lastOpp"]});if(void 0==b.Data||void 0==b.Data.lastOpp)x=q="noop";else for(u=b.Data.lastOpp.Value.split(","),b=0;b<u.length;b++)0==b&&(q=u[b]),1==b&&(x=u[b]);z=0==r?JSON.parse(v):[];var F=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];15>z.length&&(r=!0);var D=Array(z.length),A=0,v=Array(z.length);u=0;for(var E=Array(z.length),C=0,b=0;b<z.length;b++)1==r&&(F[5*Number(z[b].e)+Number(z[b].c)]=1),z[b].uId!=currentPlayerId&&(D[A]=z[b],A++,z[b].uId!=q&&(v[u]=z[b],u++,z[b].uId!=x&&(E[C]=z[b],C++)));if(1==r){r=[];
for(b=0;b<F.length;b++)0==F[b]&&r.push(b);r=r[Math.floor(Math.random()*r.length)];b=Math.floor(r/5);r%=5;x=server.GetTitleData({Keys:"MasterUser"});if(void 0!=x.Data.MasterUser&&(x=server.GetUserReadOnlyData({PlayFabId:x.Data.MasterUser,Keys:[b+"_"+r+"_RecPos",b+"_"+r+"_RecRot",b+"_"+r+"_RecHeader"]}),void 0!=x.Data&&void 0!=x.Data[b+"_"+r+"_RecPos"]&&void 0!=x.Data[b+"_"+r+"_RecRot"]&&void 0!=x.Data[b+"_"+r+"_RecHeader"])){var B=!0;0==e?(e=h,B=!1):e-=w;1>=e&&(e=1);c=parseInt(a,2);a=[];c={StatisticName:"WinLoss",
Version:"0",Value:c};a.push(c);e={StatisticName:"TrophyCount",Version:"0",Value:e};a.push(e);p={StatisticName:"League",Version:"0",Value:p};a.push(p);p={StatisticName:"TotalGames",Version:"0",Value:k};a.push(p);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:a});a={trophyWin:Math.floor((Number(h)+Number(l))/2),trophyLose:Math.floor((Number(t)+Number(w))/2)};0==B&&(a.trophyWin=0,a.trophyLose=0);server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:a});return{Result:"OK",
RecType:"TheStig",PosData:x.Data[b+"_"+r+"_RecPos"].Value,RotData:x.Data[b+"_"+r+"_RecRot"].Value,HeaderData:x.Data[b+"_"+r+"_RecHeader"].Value,TrophyLose:w,TrophyWin:h,Opp:"Mniezo"}}}if(0==A)return generateErrObj("no valid recording found for this subdivision");p=D;0<u&&(A=u,p=v);0<C&&(A=C,p=E);u=A-1;for(b=0;b<A;b++)if(p[b].wl>f){u=b;break}f=Math.min(A,3);v=Array(f);for(b=0;b<f;b++)v[b]=0>=u?p[b]:u>=A-1?p[A-1-b]:p[u-Math.floor(f/2)+b];p=Math.floor(Math.random()*f);b=v[p].uId;f=v[p].e;v=v[p].c;u=
server.GetUserReadOnlyData({PlayFabId:b,Keys:[f+"_"+v+"_RecPos",f+"_"+v+"_RecRot",f+"_"+v+"_RecHeader"]});if(void 0==u)return generateErrObj("Did not find recording for this user: "+b);var E=server.GetPlayerCombinedInfo({PlayFabId:b,InfoRequestParameters:{GetUserAccountInfo:!0,GetUserInventory:!1,GetUserVirtualCurrency:!1,GetUserData:!1,GetUserReadOnlyData:!1,GetCharacterInventories:!1,GetCharacterList:!1,GetTitleData:!1,GetPlayerStatistics:!1}}),A=e,p=Number(calculateLeague(e)),C="UserGenerated",
D=0<p?Number(m.subdivisions[c.leagues[p-1]]):0,x=p>=c.leagues.length-1?2*D:Number(m.subdivisions[c.leagues[p]]),r=JSON.parse(u.Data[f+"_"+v+"_RecHeader"].Value);void 0!=r&&(B=r.Trophies);B=Number(B);0>=x-D?(m=t,B=l):Number(Math.abs(A-B))>Number(y)?(m=Math.floor((w+t)/2)-1+Math.floor(3*Math.random()),B=Math.floor((h+l)/2)-1+Math.floor(3*Math.random()),C="MobyDick"):(m=w+Math.floor((t-w)/2*((A-B)/(x-D)+1)),B=l+Math.floor((h-l)/2*((B-A)/(x-D)+1)));r.Pr>Number(n.subdivisions[c.leagues[p-1]])&&(m=Math.floor((w+
t)/2)-1+Math.floor(3*Math.random()),B=Math.floor((h+l)/2)-1+Math.floor(3*Math.random()),C="MobyDick");l=!0;0==e?(l=!1,e=h):(e-=Number(m),1>=e&&(e=1));c=parseInt(a,2);a=[];c={StatisticName:"WinLoss",Version:"0",Value:c};a.push(c);e={StatisticName:"TrophyCount",Version:"0",Value:e};a.push(e);p={StatisticName:"League",Version:"0",Value:p};a.push(p);p={StatisticName:"TotalGames",Version:"0",Value:k};a.push(p);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:a});a={trophyWin:B,trophyLose:m,
lastOpp:b+","+q};0==l&&(a.trophyWin=0,a.trophyLose=0);server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:a});return{Result:"OK",RecType:C,PosData:u.Data[f+"_"+v+"_RecPos"].Value,RotData:u.Data[f+"_"+v+"_RecRot"].Value,HeaderData:u.Data[f+"_"+v+"_RecHeader"].Value,TrophyLose:m,TrophyWin:B,Opp:E.InfoResultPayload.AccountInfo.TitleInfo.DisplayName}};
handlers.updateCarCust=function(d,g){var a=CheckMaintenanceAndVersion(d);if("OK"!=a)return generateMaintenanceOrUpdateObj(a);for(var c=server.GetUserInventory({PlayFabId:currentPlayerId}),f=[],e="-1",k={},b={PaintJobs:{itemOwned:"no",itemCustData:d.paintId,carItemId:"PaintId"},Decals:{itemOwned:"no",itemCustData:d.decalId,carItemId:"DecalId"},Plates:{itemOwned:"no",itemCustData:d.platesId,carItemId:"PlatesId"},Rims:{itemOwned:"no",itemCustData:d.rimsId,carItemId:"RimsId"},WindshieldText:{itemOwned:"no",
itemCustData:d.wsId,carItemId:"WindshieldId"}},a=0;a<c.Inventory.length;a++)c.Inventory[a].ItemId==d.carId&&"CarsProgress"==c.Inventory[a].CatalogVersion&&(e=c.Inventory[a].ItemInstanceId),c.Inventory[a].ItemId in b&&(b[c.Inventory[a].ItemId].itemOwned="yes",b[c.Inventory[a].ItemId].itemCustData in c.Inventory[a].CustomData?k[b[c.Inventory[a].ItemId].carItemId]=b[c.Inventory[a].ItemId].itemCustData:log.debug("user doesn't own: "+c.Inventory[a].ItemId+" "+b[c.Inventory[a].ItemId].itemCustData));if("-1"==
e)return generateFailObj("User does not own car with id: "+d.carId);for(var h in b)b.hasOwnProperty(h)&&"no"==b[h].itemOwned&&f.push(h);if(k=={})return generateFailObj("User doesn't own any of those customizations");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:e,Data:k});h=[{ItemId:d.carId,CatalogVersion:"CarsProgress",CustomData:k}];if(0<f.length)for(f=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:f}),c={0:"Owned"},
a=0;a<f.ItemGrantResults.length;a++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:f.ItemGrantResults[a].ItemInstanceId,Data:c});return{Result:"OK",Message:"InventoryUpdate",InventoryChange:{Inventory:h}}};
function upgradeCar(d,g,a,c){for(var f=server.GetCatalogItems({CatalogVersion:"CarCards"}),e=!1,k,b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==d.carId&&"CarsProgress"==g.Inventory[b].CatalogVersion){e=!0;k=g.Inventory[b];break}for(var h,b=0;b<f.Catalog.length;b++)if(f.Catalog[b].ItemId==d.carId){h=JSON.parse(f.Catalog[b].CustomData);break}if(void 0===h)return generateErrObj("CardNotFoundForCarwithID: "+d.carId+". It is possible that the carCard ID and the Car ID do not coincide. Check Playfab catalog data.");
if(!0===e){var l=parseInt(k.CustomData.CarLvl)+1;if(l>=Number(h.prPerLvl.length))return generateFailObj("Maximum pr level was reached!");var m=getObjectValueFromLevel(h,"currCostPerLvl",l),b=checkBalance(h.currType,m,a,c);if("OK"!=b)return b;a=getObjectValueFromLevel(h,"cardCostPerLvl",l);k.CustomData.CarLvl=l;for(var e=!1,n,b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==d.carId&&"CarCards"==g.Inventory[b].CatalogVersion){e=!0;try{if(void 0===g.Inventory[b].CustomData)return generateFailObj("Insufficient cards, CusotmData undefined");
if(void 0===g.Inventory[b].CustomData.Amount)return generateFailObj("Insufficient cards, CusotmData.Amount udnefined");if(Number(g.Inventory[b].CustomData.Amount)>=a)g.Inventory[b].CustomData.Amount-=a,n={Amount:g.Inventory[b].CustomData.Amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[b].ItemInstanceId,Data:n});else return generateFailObj("Insufficient cards for real: "+g.Inventory[b].CustomData.Amount+" vs "+a)}catch(y){return generateFailObj("Insufficient cards")}break}if(!1===
e)return generateFailObj("No cards found");g=recalculateCarPr(k.CustomData,k.ItemId,f,void 0);b={CarLvl:l,Pr:g};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemInstanceId,Data:b});var q;0<m&&(q=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:h.currType,Amount:m}));d=[{ItemId:d.carId,CatalogVersion:"CarCards",CustomData:n},{ItemId:d.carId,CatalogVersion:"CarsProgress",CustomData:b}];n={};b={Inventory:d};void 0!=q&&(n[q.VirtualCurrency]=
q.Balance,b.VirtualCurrency=n);b.Experience=UpdateExperience("Balancing","BalancingItem","Car_"+h.rarity,l,!0);return generateInventoryChange("InventoryUpdate",b)}e=!1;for(b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==d.carId&&"CarCards"==g.Inventory[b].CatalogVersion){e=!0;try{if(void 0===g.Inventory[b].CustomData)return generateFailObj("Insufficient cards, CustomData null");if(void 0===g.Inventory[b].CustomData.Amount)return generateFailObj("Insufficient cards, CustomData.Amount null");
if(Number(g.Inventory[b].CustomData.Amount)>=Number(h.cardCostPerLvl[1]))m=g.Inventory[b].ItemInstanceId,g.Inventory[b].CustomData.Amount-=h.cardCostPerLvl[1],n={Amount:g.Inventory[b].CustomData.Amount};else return generateFailObj("Insufficient cards: "+g.Inventory[b].CustomData.Amount+" vs "+h.cardCostPerLvl[1]+".")}catch(y){return generateFailObj("Insufficient cards: "+y)}break}if(0==e)return generateFailObj("No cards found");b=checkBalance(h.currType,h.currCostPerLvl[1],a,c);if("OK"!=b)return b;
k=[];k.push(d.carId);k=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:k});if(!1===k.ItemGrantResults[0].Result)return log.error("Something went wrong while giving user the item, refunding cards"),generateFailObj("Something went wrong while giving user the item, refunding cards.");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:m,Data:n});0<h.currCostPerLvl[1]&&(q=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:h.currType,Amount:h.currCostPerLvl[1]}));b={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemGrantResults[0].ItemInstanceId,Data:b});b={TiresLvl:"0",TurboLvl:"0",PaintId:h.defaultPaintID,DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemGrantResults[0].ItemInstanceId,Data:b});b={PlatesId:"0",WindshieldId:"0",
Pr:Number(h.basePr)+h.prPerLvl[1]};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemGrantResults[0].ItemInstanceId,Data:b});f=k=!1;for(b=0;b<g.Inventory.length;b++)if("PaintJobs"==g.Inventory[b].ItemId){f=!0;void 0!=g.Inventory[b].CustomData?h.defaultPaintID in g.Inventory[b].CustomData?k=!0:(l={},l[h.defaultPaintID]="Owned"):(l={},l[h.defaultPaintID]="Owned");void 0!=l&&server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[b].ItemInstanceId,
Data:l});break}0==f&&(paintToGive=[],paintToGive.push("PaintJobs"),g=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:paintToGive}),l={},l[h.defaultPaintID]="Owned",server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.ItemGrantResults[0].ItemInstanceId,Data:l}));b={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:h.defaultPaintID,DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",
Pr:Number(h.basePr)+h.prPerLvl[1]};d=[{ItemId:d.carId,CatalogVersion:"CarCards",CustomData:n},{ItemId:d.carId,CatalogVersion:"CarsProgress",CustomData:b}];0==k&&(n={},n[h.defaultPaintID]="Owned",d.push({ItemId:"PaintJobs",CatalogVersion:"Customization",CustomData:n}));n={};b={Inventory:d};void 0!=q&&(n[q.VirtualCurrency]=q.Balance,b.VirtualCurrency=n);b.Experience=UpdateExperience("Balancing","BalancingItem","Car_"+h.rarity,1,!0);return generateInventoryChange("InventoryUpdateNewCar",b)}
function upgradePart(d,g,a,c){for(var f=server.GetCatalogItems({CatalogVersion:"CarsProgress"}),e=!1,k=0;k<f.Catalog.length;k++)if(f.Catalog[k].ItemId==d.carId){e=!0;break}if(!1===e)return generateErrObj("car with ID: "+d.carId+" not found in catalog.");for(var f=server.GetCatalogItems({CatalogVersion:"PartCards"}),e=!1,b,k=0;k<f.Catalog.length;k++)if(f.Catalog[k].ItemId==d.partId){b=JSON.parse(f.Catalog[k].CustomData);e=!0;break}if(0==e)return generateErrObj("part with ID: "+d.partId+" not found in catalog.");
for(var e=!1,h,k=0;k<g.Inventory.length;k++)if(g.Inventory[k].ItemId==d.carId&&"CarsProgress"==g.Inventory[k].CatalogVersion){e=!0;h=g.Inventory[k];break}if(!1===e)return generateFailObj("car with ID: "+d.carId+" not found in user inventory.");for(var l=!1,e=0,m={},k=0;k<g.Inventory.length;k++)if(g.Inventory[k].ItemId==d.partId&&"PartCards"==g.Inventory[k].CatalogVersion){var l=!0,n={Exhaust:"ExhaustLvl",Engine:"EngineLvl",Gearbox:"GearboxLvl",Suspension:"SuspensionLvl",Tires:"TiresLvl",Turbo:"TurboLvl"},
e=parseInt(h.CustomData[n[d.partId]])+1;if(e>=Number(b.prPerLvl.length))return generateFailObj("Maximum pr level was reached!");var q=getObjectValueFromLevel(b,"cardCostPerLvl",e),y=getObjectValueFromLevel(b,"currCostPerLvl",e);m[n[d.partId]]=e;h.CustomData[n[d.partId]]=e;var w;a=checkBalance(b.currType,y,a,c);if("OK"!=a)return a;try{if(void 0!==g.Inventory[k].CustomData&&void 0!==g.Inventory[k].CustomData.Amount&&g.Inventory[k].CustomData.Amount>=q)g.Inventory[k].CustomData.Amount-=q,w={Amount:g.Inventory[k].CustomData.Amount},
server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[k].ItemInstanceId,Data:w});else return generateFailObj("Insufficient cards")}catch(v){return generateFailObj("Insufficient cards")}break}if(0==l)return generateFailObj("Part not found");var t;0<y&&(t=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:b.currType,Amount:y}));k=recalculateCarPr(h.CustomData,h.ItemId,void 0,f);m.Pr=k;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:h.ItemInstanceId,Data:m});h={};k={Inventory:[{ItemId:d.partId,CatalogVersion:"PartCards",CustomData:w},{ItemId:d.carId,CatalogVersion:"CarsProgress",CustomData:m}]};void 0!==t&&(h[t.VirtualCurrency]=t.Balance,k.VirtualCurrency=h);k.Experience=UpdateExperience("Balancing","BalancingItem","Parts_"+b.rarity,e,!0);return generateInventoryChange("InventoryUpdatePart",k)};
