function checkCarDataValidity(c,g){if(void 0==c.CustomData){try{var a={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemInstanceId,Data:a});a={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemInstanceId,Data:a});for(var f=0,e=0;e<g.Catalog.length;e++)if(g.Catalog[e].ItemId==c.ItemId){var d=
JSON.parse(g.Catalog[e].CustomData),f=parseInt(d.basePr);break}a={PlatesId:"0",WindshieldId:"0",Pr:f};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemInstanceId,Data:a})}catch(h){return"PlayFabError"}return{CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",Pr:f}}return"OK"}function generateFailObj(c){return{Result:"Failed",Message:c}}
function generateErrObj(c){return{Result:"Error",Message:c}}function generateInventoryChange(c,g){return{Result:"OK",Message:c,InventoryChange:g}}function checkBalance(c,g,a,f){if("SC"==c){if(a<g)return generateFailObj("NotEnoughSC")}else if(f<g)return generateFailObj("NotEnoughHC");return"OK"}
function calculateLeague(c){var g=server.GetTitleData({Keys:["LeagueSubdivisions","SubdivisionTrophyRanges"]});if(void 0==g.Data.LeagueSubdivisions||void 0==g.Data.SubdivisionTrophyRanges)return 1;for(var a=JSON.parse(g.Data.LeagueSubdivisions).leagues,g=JSON.parse(g.Data.SubdivisionTrophyRanges).subdivisions,f=0;f<a.length;f++)if(!(Number(c)>Number(g[a[f]])))return f}
function recalculateCarPr(c,g,a,f){var e=0,d;d=void 0===a?server.GetCatalogItems({CatalogVersion:"CarCards"}):a;for(a=0;a<d.Catalog.length;a++)if(d.Catalog[a].ItemId==g){e=JSON.parse(d.Catalog[a].CustomData);e=parseInt(e.basePr)+getObjectValueFromLevel(e,"prPerLvl",c.CarLvl);break}f=void 0===f?server.GetCatalogItems({CatalogVersion:"PartCards"}):f;c={Exhaust:c.ExhaustLvl,Engine:c.EngineLvl,Gearbox:c.GearboxLvl,Suspension:c.SuspensionLvl,Tires:c.TiresLvl,Turbo:c.TurboLvl};for(a=0;a<f.Catalog.length;a++)g=
JSON.parse(f.Catalog[a].CustomData),e+=getObjectValueFromLevel(g,"prPerLvl",Number(c[f.Catalog[a].ItemId]));return e}
function GenerateBlackMarket(c){var g=1,a=server.GetPlayerStatistics({PlayFabId:c,StatisticNames:["League"]});0!=a.Statistics.length&&(g=a.Statistics[0].Value.toString());var f=server.GetCatalogItems({CatalogVersion:"PartCards"}),a={};a.BMTime=(new Date).getTime();var e=Math.floor(Math.random()*f.Catalog.length),d=JSON.parse(f.Catalog[e].CustomData);if(void 0==d)return generateErrObj("Part card "+f.Catalog[b].ItemId+" has no custom data.");a.BMItem0=f.Catalog[e].ItemId+"_"+d.BMCurrType+"_"+d.BMbasePrice+
"_0_"+d.BMpriceIncrPerBuy;var h=Math.floor(Math.random()*f.Catalog.length);h==e&&(h=f.Catalog.length-e-1);d=JSON.parse(f.Catalog[h].CustomData);if(void 0==d)return generateErrObj("Part card "+f.Catalog[b].ItemId+" has no custom data.");a.BMItem1=f.Catalog[h].ItemId+"_"+d.BMCurrType+"_"+d.BMbasePrice+"_0_"+d.BMpriceIncrPerBuy;for(var f=server.GetCatalogItems({CatalogVersion:"CarCards"}),d=[],h=[],b=0;b<f.Catalog.length;b++){e=JSON.parse(f.Catalog[b].CustomData);if(void 0==e)return generateErrObj("Car card "+
f.Catalog[b].ItemId+" has no custom data.");e.unlockedAtRank>g+1||("false"==e.rareCar?d.push(f.Catalog[b].ItemId+"_"+e.BMCurrType+"_"+e.BMbasePrice+"_0_"+e.BMpriceIncrPerBuy):h.push(f.Catalog[b].ItemId+"_"+e.BMCurrType+"_"+e.BMbasePrice+"_0_"+e.BMpriceIncrPerBuy))}0>=d.length?(a.BMItem2=h[Math.floor(Math.random()*h.length)],a.BMItem3=h[Math.floor(Math.random()*h.length)]):0>=h.length?(a.BMItem2=d[Math.floor(Math.random()*d.length)],a.BMItem3=d[Math.floor(Math.random()*d.length)]):(a.BMItem2=d[Math.floor(Math.random()*
d.length)],a.BMItem3=h[Math.floor(Math.random()*h.length)]);server.UpdateUserInternalData({PlayFabId:c,Data:a});g=[];g.push("BlackMarketResetMinutes");c=server.GetTitleData({PlayFabId:c,Keys:g});a.BMTime=60*parseInt(c.Data.BlackMarketResetMinutes);return a}
function GetCurrentBlackMarket(c,g){var a={},f=new Date,e=[];e.push("BlackMarketResetMinutes");e=server.GetTitleData({PlayFabId:c,Keys:e});a.BMTime=60*parseInt(e.Data.BlackMarketResetMinutes)-Math.floor((f.getTime()-g.Data.BMTime.Value)/1E3);for(f=0;4>f;f++)a["BMItem"+f]=g.Data["BMItem"+f].Value;return a}function GetValueFromStatistics(c,g,a){for(var f,e=0;e<c.length;e++)c[e].StatisticName===g&&(f=c[e]);return void 0===f?void 0!==a?a:0:Number(f.Value)}
function getCatalogItem(c,g){for(var a=server.GetCatalogItems({CatalogVersion:c}),f=0;f<a.Catalog.length;f++)if(a.Catalog[f].ItemId===g)return a.Catalog[f]}function getObjectValueFromLevel(c,g,a,f){f||(f=0);if(!c[g]||!c[g].length)return f;var e=Number(c[g].length);a>=e&&(a=e-1);return Number(c[g][a])||f}
handlers.buyChest=function(c,g){var a=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(c.curr,c.cost,a.VirtualCurrency.SC,a.VirtualCurrency.HC))return generateFailObj("not enough money");if(0<c.cost){var a=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:c.curr,Amount:c.cost}),f={};f[a.VirtualCurrency]=a.Balance;return generateInventoryChange("ChestBought",{VirtualCurrency:f})}return generateInventoryChange("ChestBought",{})};
handlers.endGame=function(c,g){var a="01",f,e="0";"rWin"==c.outcome&&(e="1");var d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});0!=d.Statistics.length&&(f=d.Statistics[0].Value.toString(),a=Number(f).toString(2));var d=0,h;h=Array(a.length);for(var b=0;b<h.length-1;b++)h[b]=a[b];h[h.length-1]=e;a=h;e=a.length;for(b=0;b<a.length;b++)"1"==a[b]&&d++;h=Math.round(d/e*100);var k=server.GetTitleData({Key:["LeagueSubdivisions","SubdivisionTrophyRanges"]}),e=0,l,d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,
StatisticNames:["TrophyCount"]});0!=d.Statistics.length&&(e=d.Statistics[0].Value,log.debug("getting trophy count "+d.Statistics[0].Value));l=e=Number(e);d=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:["trophyLose","trophyWin"]});d=void 0==d.Data.trophyLose||void 0==d.Data.trophyWin?45:Number(d.Data.trophyLose.Value)+Number(d.Data.trophyWin.Value);"rWin"==c.outcome&&(e+=d);log.debug("trophies change: "+l+" => "+e);d=calculateLeague(e);for(b=f=0;b<a.length;b++)"1"==a[b]&&(f+=Math.pow(2,
b));b=[];b.push({StatisticName:"WinLoss",Version:"0",Value:f});a={StatisticName:"TrophyCount",Version:"0",Value:e};b.push(a);a={StatisticName:"League",Version:"0",Value:d};b.push(a);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:b});b=JSON.parse(c.recordingHeader);if(10>=Number(b.Score)){var p={TrophyCount:e,League:d};return{Result:p}}b=JSON.parse(c.recordingHeader);log.debug("score: "+b.Score);a=JSON.parse(k.Data.SubdivisionTrophyRanges);for(b=0;b<a.subdivisions.length;b++)if(l<
a.subdivisions[b]){p=b;break}b=[];b.push({Key:c.envIndex+"_"+c.courseIndex+"_RecPos",Value:c.recordingPos});b.push({Key:c.envIndex+"_"+c.courseIndex+"_RecRot",Value:c.recordingRot});b.push({Key:c.envIndex+"_"+c.courseIndex+"_RecHeader",Value:c.recordingHeader});server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:b});b=server.GetTitleInternalData({Key:"RecSubDivision"+p}).Data["RecSubDivision"+p];if(void 0==b)a=[],h={wl:h,e:c.envIndex,c:c.courseIndex,uId:currentPlayerId},a.push(h);else{a=
JSON.parse(b);h={wl:h,e:c.envIndex,c:c.courseIndex,uId:currentPlayerId};k=!1;for(b=l=0;b<a.length;b++)a[b].uId==currentPlayerId&&l++;if(2<l)return p={TrophyCount:e,League:d},{Result:p};for(b=0;b<a.length;b++)if(a[b].e==c.envIndex&&a[b].c==c.courseIndex){k=!0;a[b]=h;if(1==a.length)break;if(0<b)if(a[b].wl>a[b-1].wl){if(b==a.length-1)break;for(l=b+1;l<a.length;l++)if(a[l-1].wl>a[l].wl)f=a[l],a[l]=a[l-1],a[l-1]=f;else break}else for(l=b-1;0<=l;l--)if(a[l+1].wl<a[l].wl)f=a[l],a[l]=a[l+1],a[l+1]=f;else break;
else for(l=b+1;l<a.length;l++)if(a[l-1].wl>a[l].wl)f=a[l],a[l]=a[l-1],a[l-1]=f;else break}0==k&&a.push(h)}b=JSON.stringify(a);server.SetTitleInternalData({Key:"RecSubDivision"+p,Value:b});p={TrophyCount:e,League:d};return{Result:p}};
function UpdateExperience(c,g,a,f,e,d){c=JSON.parse(getCatalogItem(c,g).CustomData)[a];g=JSON.parse(getCatalogItem("Balancing","BalancingItem").CustomData).LevelThresholds;g=g[g.length-1];d=d||server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["Experience"]}).Statistics;d=GetValueFromStatistics(d,"Experience",0);if(d>=g)return g;if(isNaN(Number(c)))a=Number(c.length),f>=a&&(f=a-1),f=Number(c[f]);else if(f=Number(c),0===f)return d;d=Math.min(d+f,g);if(!e)return d;server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,
Statistics:[{StatisticName:"Experience",Version:"0",Value:d}]});return d}handlers.getServerTime=function(c,g){return{time:new Date}};handlers.giveMoney=function(c){c=server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:c.curr,Amount:c.amount});var g={};g[c.VirtualCurrency]=c.Balance;return{Result:"OK",Message:"CurrencyChanged",InventoryChange:{VirtualCurrency:g}}};
handlers.grantItems=function(c){for(var g=server.GetUserInventory({PlayFabId:currentPlayerId}),a,f=!1,e=0;e<g.Inventory.length;e++)if(g.Inventory[e].ItemId==c.itemId&&g.Inventory[e].CatalogVersion==c.catalogId){a=void 0==g.Inventory[e].CustomData?c.amount:void 0==g.Inventory[e].CustomData.Amount?c.amount:isNaN(Number(g.Inventory[e].CustomData.Amount))?c.amount:Number(g.Inventory[e].CustomData.Amount)+c.amount;a={Amount:a};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[e].ItemInstanceId,
Data:a});f=!0;break}0==f&&(g=[],g.push(c.itemId),g=server.GrantItemsToUser({CatalogVersion:c.catalogId,PlayFabId:currentPlayerId,ItemIds:g}),a={Amount:c.amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.ItemGrantResults[0].ItemInstanceId,Data:a}));return{Result:"OK",Message:"InventoryUpdated",InventoryChange:{Inventory:[{ItemId:c.itemId,CatalogVersion:c.catalogId,CustomData:a}]}}};
handlers.initServerData=function(c){c=[];var g={StatisticName:"TrophyCount",Version:"0",Value:"0"};c.push(g);g={StatisticName:"League",Version:"0",Value:"0"};c.push(g);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:c});c=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:["Decals","PaintJobs","Plates","Rims","WindshieldText"]});for(var g={0:"Owned"},a=0;a<c.ItemGrantResults.length;a++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:c.ItemGrantResults[a].ItemInstanceId,Data:g});c=[];c.push("FordFocus");c=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:c});g={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g});g={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g});g={PlatesId:"0",WindshieldId:"0",Pr:"10"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g});g=[];g.push("Engine");g=server.GrantItemsToUser({CatalogVersion:"PartCards",PlayFabId:currentPlayerId,ItemIds:g});server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.ItemGrantResults[0].ItemInstanceId,Data:{Amount:"5"}});g={CarLvl:"1",EngineLvl:"0",
ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g})};
handlers.openChest=function(c,g){if(1==c.isLevelUp){var a=server.GetUserReadOnlyData({PlayFabId:currentPlayerId,Keys:["LastLevelReward"]}),f={LastLevelReward:0};void 0==a.Data.LastLevelReward&&(server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:f}),a.Data.LastLevelReward=0);var e=JSON.parse(getCatalogItem("Balancing","BalancingItem").CustomData).LevelThresholds,d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["Experience"]}).Statistics,h=GetValueFromStatistics(d,
"Experience",0);0==h&&(d=[],d.push({StatisticName:"Experience",Version:"0",Value:0}),server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:d}));for(var b=100,d=0;d<e.length;d++)if(!(h>=e[d])){b=d;break}if(Number(a.Data.LastLevelReward)<Number(b))a.Data.LastLevelReward=Number(a.Data.LastLevelReward)+1,f.LastLevelReward=a.Data.LastLevelReward,server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:f}),d=""+a.Data.LastLevelReward,d="000".substring(0,3-d.length)+d,server.GrantItemsToUser({CatalogVersion:"LevelUpRewards",
PlayFabId:currentPlayerId,ItemIds:d});else return generateFailObj("already got reward for level: "+a.Data.LastLevelReward)}a=server.GetUserInventory({PlayFabId:currentPlayerId});if(0<c.currCost){if("OK"!=checkBalance(c.currType,c.currCost,a.VirtualCurrency.SC,a.VirtualCurrency.HC))return generateFailObj("not enough money");server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:c.currType,Amount:c.currCost})}for(var k in c.currencyReq)0<c.currencyReq[k]&&server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:k,Amount:c.currencyReq[k]});for(k in c.carCardsRequest)if(c.carCardsRequest.hasOwnProperty(k)){f=!1;for(d=0;d<a.Inventory.length;d++)if(a.Inventory[d].ItemId==k&&"CarCards"==a.Inventory[d].CatalogVersion){f=void 0==a.Inventory[d].CustomData?Number(c.carCardsRequest[k]):void 0==a.Inventory[d].CustomData.Amount?Number(c.carCardsRequest[k]):isNaN(Number(a.Inventory[d].CustomData.Amount))?Number(c.carCardsRequest[k]):Number(a.Inventory[d].CustomData.Amount)+Number(c.carCardsRequest[k]);
f={Amount:f};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[d].ItemInstanceId,Data:f});f=!0;break}0==f&&(d=[k],d=server.GrantItemsToUser({CatalogVersion:"CarCards",PlayFabId:currentPlayerId,ItemIds:d}),f={Amount:c.carCardsRequest[k]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:f}))}for(k in c.partCardsRequest)if(c.partCardsRequest.hasOwnProperty(k)){f=!1;for(d=0;d<a.Inventory.length;d++)if(a.Inventory[d].ItemId==
k&&"PartCards"==a.Inventory[d].CatalogVersion){f=void 0==a.Inventory[d].CustomData?Number(c.partCardsRequest[k]):void 0==a.Inventory[d].CustomData.Amount?Number(c.partCardsRequest[k]):isNaN(Number(a.Inventory[d].CustomData.Amount))?Number(c.partCardsRequest[k]):Number(a.Inventory[d].CustomData.Amount)+Number(c.partCardsRequest[k]);f={Amount:f};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[d].ItemInstanceId,Data:f});f=!0;break}0==f&&(d=[k],d=server.GrantItemsToUser({CatalogVersion:"PartCards",
PlayFabId:currentPlayerId,ItemIds:d}),f={Amount:c.partCardsRequest[k]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:d.ItemGrantResults[0].ItemInstanceId,Data:f}))}k=server.GetUserInventory({PlayFabId:currentPlayerId});c.chestId&&1!=c.isLevelUp&&(d=UpdateExperience("Chests",c.chestId,"xpGain",0,!0),k.Experience=d);return generateInventoryChange("InventoryUpdated",k)};
handlers.purchaseBMItem=function(c,g){if(0>c.itemId||3<c.itemId)return generateFailObj("invalid item index");var a=[];a.push("BMItem"+c.itemId);var a=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:a}),f=server.GetUserInventory({PlayFabId:currentPlayerId}),a=a.Data["BMItem"+c.itemId].Value.split("_"),e=f.VirtualCurrency[a[1]];5!=a.length&&generateErrObj("User Black Market corrupted. Try again tomorrow");var d;d=2>c.itemId?"PartCards":"CarCards";var h=parseInt(a[2])+parseInt(a[3])*parseInt(a[4]),
e=checkBalance(a[1],h,e,e);if("OK"!=e)return e;for(var b,k,e=0;e<f.Inventory.length;e++)if(f.Inventory[e].ItemId==a[0]&&f.Inventory[e].CatalogVersion==d){b=f.Inventory[e].ItemInstanceId;void 0===f.Inventory[e].CustomData?k={Amount:1}:void 0===f.Inventory[e].CustomData.Amount?k={Amount:1}:(k=Number(f.Inventory[e].CustomData.Amount)+1,isNaN(k)&&(k=1),k={Amount:k});server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b,Data:k});break}void 0===b&&(b=[],b.push(a[0]),b=server.GrantItemsToUser({CatalogVersion:d,
PlayFabId:currentPlayerId,ItemIds:b}).ItemGrantResults[0].ItemInstanceId,void 0===b?generateErrObj("grantRequest denied"):(k={Amount:1},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b,Data:k})));b=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a[1],Amount:h});h=a[0]+"_"+a[1]+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];f={};f["BMItem"+c.itemId]=h;server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:f});k=[{ItemId:a[0],CatalogVersion:d,
CustomData:k}];d={};d[b.VirtualCurrency]=b.Balance;a=c.itemId+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];e={Inventory:k,VirtualCurrency:d};return{Result:"OK",Message:"InventoryUpdate",InventoryChange:e,BMItemChange:a}};
handlers.purchaseItems=function(c,g){var a=server.GetUserInventory({PlayFabId:currentPlayerId}),f=a.VirtualCurrency.SC,e=a.VirtualCurrency.HC;switch(c.purchaseType){case "carUpgrade":return upgradeCar(c,a,f,e);case "partUpgrade":return upgradePart(c,a,f,e);case "custPurchase":for(var d=server.GetCatalogItems({CatalogVersion:"Customization"}),h,b=0,k="SC",l=0;l<d.Catalog.length;l++)if(d.Catalog[l].ItemId==c.custId){h=d.Catalog[l];cardInfo=JSON.parse(d.Catalog[l].CustomData);b=c.custVal+",Cost";k=cardInfo[c.custVal+
",Curr"];b=cardInfo[b];e=checkBalance(k,b,f,e);if("OK"!=e)return e;break}if(void 0==h)return generateErrObj("Customization does not exist in catalog.");for(var p,n,l=0;l<a.Inventory.length;l++)if(a.Inventory[l].ItemId==c.custId){p=a.Inventory[l];n=a.Inventory[l].ItemInstanceId;if(void 0!=p.CustomData&&String(c.custVal)in p.CustomData)return generateFailObj("User already has this customization.");break}if(void 0==p){log.info("user doesn't have customization category. Granting ... ");e=[];e.push(c.custId);
e=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:e});if(0==e.ItemGrantResults[0].Result)return generateErrObj("something went wrong while granting user customization class object.");n=e.ItemGrantResults[0].ItemInstanceId}e={};e[String(c.custVal)]="Owned";server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:n,Data:e});e=[{ItemId:c.custId,CatalogVersion:"Customization",CustomData:e}];0<b?(k=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:k,Amount:b}),b={},b[k.VirtualCurrency]=k.Balance,l={Inventory:e,VirtualCurrency:b}):l={Inventory:e};return generateInventoryChange("InventoryUpdateNewCustomization",l);case "softCurrencyPurchase":k=server.GetCatalogItems({CatalogVersion:"SoftCurrencyStore"});b=!1;for(l=n=0;l<k.Catalog.length;l++)if(k.Catalog[l].ItemId==c.packId){n=k.Catalog[l].VirtualCurrencyPrices.HC;cardInfo=JSON.parse(k.Catalog[l].CustomData);b=!0;break}if(0==b)return generateErrObj("pack with ID: "+c.packId+" not found in catalog.");
if(0>=n)return generateErrObj("pack with ID: "+c.packId+" shouldn't have negative cost.");if(n>e)return generateFailObj("Not enough HC.");k=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"HC",Amount:n});e=server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"SC",Amount:cardInfo.quantity});b={};b[e.VirtualCurrency]=e.Balance;b[k.VirtualCurrency]=k.Balance;return generateInventoryChange("SoftCurrencyPurchased",{VirtualCurrency:b});default:log.debug("invalid purchase parameter")}};
handlers.requestCurrency=function(c){return{VirtualCurrency:server.GetUserInventory({PlayFabId:currentPlayerId}).VirtualCurrency}};
handlers.requestInventory=function(c){c=server.GetUserInventory({PlayFabId:currentPlayerId});for(var g=server.GetCatalogItems({CatalogVersion:"CarCards"}),a=server.GetCatalogItems({CatalogVersion:"PartCards"}),f=!1,e=0;e<c.Inventory.length;e++)if("CarsProgress"==c.Inventory[e].CatalogVersion){var f=!0,d=checkCarDataValidity(c.Inventory[e],g);if("PlayFabError"==d||void 0===d)return generateErrObj("PlayfabError");"OK"==d?log.debug("Data for "+c.Inventory[e].ItemId+" OK"):c.Inventory[e].CustomData=d;
c.Inventory[e].CustomData.Pr=recalculateCarPr(c.Inventory[e].CustomData,c.Inventory[e].ItemId,g,a);d={};d.Pr=c.Inventory[e].CustomData.Pr;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.Inventory[e].ItemInstanceId,Data:d})}return!1===f?(c=[],c.push("FordFocus"),c=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:c}),g={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g}),g={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g}),g={PlatesId:"0",WindshieldId:"0",Pr:"10"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:g}),generateErrObj("UserHasNoCars ... reiniting")):c};
handlers.retrieveBlackMarket=function(c,g){var a=[];a.push("BMTime");for(var f=0;4>f;f++)a.push("BMItem"+f);a=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:a});if(void 0===a.Data.BMTime)return GenerateBlackMarket(currentPlayerId);var f=new Date,e=[];e.push("BlackMarketResetMinutes");e=server.GetTitleData({PlayFabId:currentPlayerId,Keys:e});if(!0===c.reset){a="HC";f=200;e=server.GetTitleData({Keys:["BlackMarketResetCost"]});void 0!==e.Data.BlackMarketResetCost&&(f=e.Data.BlackMarketResetCost.split("_"),
a=f[0],f=Number(f[1]));if(0<f){e=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(a,f,e.VirtualCurrency.SC,e.VirtualCurrency.HC))return generateFailObj("not enough money");f=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a,Amount:f});a=GenerateBlackMarket(currentPlayerId);e={};e[f.VirtualCurrency]=f.Balance;f={VirtualCurrency:e};a.InventoryChange=f;return a}return GenerateBlackMarket(currentPlayerId)}return f.getTime()-parseInt(a.Data.BMTime.Value)>
6E4*parseInt(e.Data.BlackMarketResetMinutes)?GenerateBlackMarket(currentPlayerId):GetCurrentBlackMarket(currentPlayerId,a)};
handlers.startGame=function(c,g){var a="10",f,e=50,d,h=0;d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});if(0!=d.Statistics.length){f=d.Statistics[0].Value.toString();a=Number(f).toString(2);d=a.length;for(var b=0;b<a.length;b++)"1"==a[b]&&h++;e=Math.round(h/d*100)}a+="0";20<a.length&&(a=a.slice(1));var k=server.GetTitleData({Key:["LeagueSubdivisions","SubdivisionTrophyRanges","TrophyGainRange","TrophyLoseRange"]});d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,
StatisticNames:["TrophyCount"]});h=0;0!=d.Statistics.length&&(h=d.Statistics[0].Value);var h=Number(h),l=JSON.parse(k.Data.SubdivisionTrophyRanges),p=JSON.parse(k.Data.LeagueSubdivisions),n=43,m=43,u;d=k.Data.TrophyGainRange.split("_");u=k.Data.TrophyLoseRange.split("_");f=Number(d[0]);d=Number(d[1]);for(var k=Number(u[0]),z=Number(u[1]),b=0;b<l.subdivisions.length;b++)if(h<Number(l.subdivisions[b])){n=b;b<l.subdivisions.length-1&&(m=b+1);break}u=Number(l.subdivisions[m])-Number(l.subdivisions[n]);
log.debug("nextSubDivision "+m+" subDivision "+n);log.debug(" sdvalParsed.subdivisions[nextSubDivision] "+l.subdivisions[m]+" sdvalParsed.subdivisions[subDivision] "+l.subdivisions[n]);0>=u&&(u=400);log.debug("subDivisionRange "+u);var r=server.GetTitleInternalData({Keys:"RecSubDivision"+n}).Data["RecSubDivision"+n],m=!1;void 0==r&&(m=!0);var v,q=n="noop",w,b=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:["lastOpp"]});if(void 0==b.Data||void 0==b.Data.lastOpp)q=n="noop";else for(w=b.Data.lastOpp.Value.split(","),
b=0;b<w.length;b++)0==b&&(n=w[b]),1==b&&(q=w[b]);v=0==m?JSON.parse(r):[];var C=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];15>v.length&&(m=!0);var D=Array(v.length),B=0,r=Array(v.length);w=0;for(var A=Array(v.length),x=0,b=0;b<v.length;b++)1==m&&(C[5*Number(v[b].e)+Number(v[b].c)]=1),v[b].uId!=currentPlayerId&&(D[B]=v[b],B++,v[b].uId!=n&&(r[w]=v[b],w++,v[b].uId!=q&&(A[x]=v[b],x++)));if(1==m){for(b=q=m=0;b<C.length;b++)if(0==C[b]){m=Math.floor(b/5);q=b%5;break}b=server.GetTitleData({Keys:"MasterUser"});if(void 0!=
b.Data.MasterUser&&(b=server.GetUserReadOnlyData({PlayFabId:b.Data.MasterUser,Keys:[m+"_"+q+"_RecPos",m+"_"+q+"_RecRot",m+"_"+q+"_RecHeader"]}),void 0!=b.Data&&void 0!=b.Data[m+"_"+q+"_RecPos"]&&void 0!=b.Data[m+"_"+q+"_RecRot"]&&void 0!=b.Data[m+"_"+q+"_RecHeader"])){n=!0;0==h?(h=d,n=!1):h-=k;1>=h&&(h=1);f=parseInt(a,2);var a=[],y={StatisticName:"WinLoss",Version:"0",Value:f};a.push(y);h={StatisticName:"TrophyCount",Version:"0",Value:h};a.push(h);h={StatisticName:"League",Version:"0",Value:t};a.push(h);
server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:a});a={trophyWin:d,trophyLose:k};0==n&&(a.trophyWin=0,a.trophyLose=0);server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:a});return{Result:"OK",RecType:"Default",PosData:b.Data[m+"_"+q+"_RecPos"].Value,RotData:b.Data[m+"_"+q+"_RecRot"].Value,HeaderData:b.Data[m+"_"+q+"_RecHeader"].Value,TrophyLose:k,TrophyWin:d,Opp:"Mniezo"}}}if(0==B)return generateErrObj("no valid recording found for this subdivision");t=D;m=B;0<w&&(m=
w,t=r);0<x&&(m=x,t=A);r=m-1;for(b=0;b<m;b++)if(t[b].wl>e){r=b;break}e=Math.min(m,3);q=Array(e);for(b=0;b<e;b++)q[b]=0>=r?t[b]:r>=m-1?t[m-1-b]:t[r-Math.floor(e/2)+b];t=Math.floor(Math.random()*e);b=q[t].uId;e=q[t].e;m=q[t].c;q=server.GetUserReadOnlyData({PlayFabId:b,Keys:[e+"_"+m+"_RecPos",e+"_"+m+"_RecRot",e+"_"+m+"_RecHeader"]});if(void 0==q)return generateErrObj("Did not find recording for this user: "+b);var r=server.GetPlayerCombinedInfo({PlayFabId:b,InfoRequestParameters:{GetUserAccountInfo:!0,
GetUserInventory:!1,GetUserVirtualCurrency:!1,GetUserData:!1,GetUserReadOnlyData:!1,GetCharacterInventories:!1,GetCharacterList:!1,GetTitleData:!1,GetPlayerStatistics:!1}}),A=h,t=Number(calculateLeague(h));w="UserGenerated";x=0<t?Number(l.subdivisions[p.leagues[t-1]]):0;p=t>=p.leagues.length-1?2*x:Number(l.subdivisions[p.leagues[t]]);l=JSON.parse(q.Data[e+"_"+m+"_RecHeader"].Value);void 0!=l&&(y=l.Trophies);y=Number(y);0>=p-x?l=d:Number(Math.abs(A-y))>Number(u)?(l=Math.floor((k+z)/2),k=Math.floor((d+
f)/2),w="Default"):(l=k+Math.floor((z-k)/2*((A-y)/(p-x)+1)),k=f+Math.floor((d-f)/2*((y-A)/(p-x)+1)));p=!0;0==h?(p=!1,h=d):(h-=Number(l),1>=h&&(h=1));f=parseInt(a,2);a=[];y={StatisticName:"WinLoss",Version:"0",Value:f};a.push(y);h={StatisticName:"TrophyCount",Version:"0",Value:h};a.push(h);h={StatisticName:"League",Version:"0",Value:t};a.push(h);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:a});a={trophyWin:k,trophyLose:l,lastOpp:b+","+n};0==p&&(a.trophyWin=0,a.trophyLose=0);
server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:a});return{Result:"OK",RecType:w,PosData:q.Data[e+"_"+m+"_RecPos"].Value,RotData:q.Data[e+"_"+m+"_RecRot"].Value,HeaderData:q.Data[e+"_"+m+"_RecHeader"].Value,TrophyLose:l,TrophyWin:k,Opp:r.InfoResultPayload.AccountInfo.TitleInfo.DisplayName}};
handlers.updateCarCust=function(c,g){for(var a=server.GetUserInventory({PlayFabId:currentPlayerId}),f=[],e="-1",d={},h={PaintJobs:{itemOwned:"no",itemCustData:c.paintId,carItemId:"PaintId"},Decals:{itemOwned:"no",itemCustData:c.decalId,carItemId:"DecalId"},Plates:{itemOwned:"no",itemCustData:c.platesId,carItemId:"PlatesId"},Rims:{itemOwned:"no",itemCustData:c.rimsId,carItemId:"RimsId"},WindshieldText:{itemOwned:"no",itemCustData:c.wsId,carItemId:"WindshieldId"}},b=0;b<a.Inventory.length;b++)a.Inventory[b].ItemId==
c.carId&&"CarsProgress"==a.Inventory[b].CatalogVersion&&(e=a.Inventory[b].ItemInstanceId),a.Inventory[b].ItemId in h&&(h[a.Inventory[b].ItemId].itemOwned="yes",h[a.Inventory[b].ItemId].itemCustData in a.Inventory[b].CustomData?d[h[a.Inventory[b].ItemId].carItemId]=h[a.Inventory[b].ItemId].itemCustData:log.debug("user doesn't own: "+a.Inventory[b].ItemId+" "+h[a.Inventory[b].ItemId].itemCustData));if("-1"==e)return generateFailObj("User does not own car with id: "+c.carId);for(var k in h)h.hasOwnProperty(k)&&
"no"==h[k].itemOwned&&f.push(k);if(d=={})return generateFailObj("User doesn't own any of those customizations");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:e,Data:d});a=[{ItemId:c.carId,CatalogVersion:"CarsProgress",CustomData:d}];if(0<f.length)for(f=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:f}),e={0:"Owned"},b=0;b<f.ItemGrantResults.length;b++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:f.ItemGrantResults[b].ItemInstanceId,Data:e});return{Result:"OK",Message:"InventoryUpdate",InventoryChange:{Inventory:a}}};
handlers.updateTrophyCount=function(c,g){var a=0,f=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]});0!==f.Statistics.length&&(a=f.Statistics[0].Value);"rStart"==c.val&&(a-=30);0>a&&(a=0);"rWin"==c.val&&(a+=60);if("rLose"==c.val)return{val:a};f=[];f.push({StatisticName:"TrophyCount",Version:"0",Value:a});server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:f});if("rWin"==c.val)return{val:a}};
function upgradeCar(c,g,a,f){for(var e=server.GetCatalogItems({CatalogVersion:"CarCards"}),d=!1,h,b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==c.carId&&"CarsProgress"==g.Inventory[b].CatalogVersion){d=!0;h=g.Inventory[b];break}for(var k,b=0;b<e.Catalog.length;b++)if(e.Catalog[b].ItemId==c.carId){k=JSON.parse(e.Catalog[b].CustomData);break}if(void 0===k)return generateErrObj("CardNotFoundForCarwithID: "+c.carId+". It is possible that the carCard ID and the Car ID do not coincide. Check Playfab catalog data.");
if(!0===d){var l=parseInt(h.CustomData.CarLvl)+1;if(l>=Number(k.prPerLvl.length))return generateFailObj("Maximum pr level was reached!");var p=getObjectValueFromLevel(k,"currCostPerLvl",l),b=checkBalance(k.currType,p,a,f);if("OK"!=b)return b;a=getObjectValueFromLevel(k,"cardCostPerLvl",l);h.CustomData.CarLvl=l;for(var d=!1,n,b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==c.carId&&"CarCards"==g.Inventory[b].CatalogVersion){d=!0;try{if(void 0===g.Inventory[b].CustomData)return generateFailObj("Insufficient cards, CusotmData undefined");
if(void 0===g.Inventory[b].CustomData.Amount)return generateFailObj("Insufficient cards, CusotmData.Amount udnefined");if(Number(g.Inventory[b].CustomData.Amount)>=a)g.Inventory[b].CustomData.Amount-=a,n={Amount:g.Inventory[b].CustomData.Amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[b].ItemInstanceId,Data:n});else return generateFailObj("Insufficient cards for real: "+g.Inventory[b].CustomData.Amount+" vs "+a)}catch(u){return generateFailObj("Insufficient cards")}break}if(!1===
d)return generateFailObj("No cards found");g=recalculateCarPr(h.CustomData,h.ItemId,e,void 0);b={CarLvl:l,Pr:g};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:h.ItemInstanceId,Data:b});var m;0<p&&(m=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:k.currType,Amount:p}));c=[{ItemId:c.carId,CatalogVersion:"CarCards",CustomData:n},{ItemId:c.carId,CatalogVersion:"CarsProgress",CustomData:b}];n={};b={Inventory:c};void 0!=m&&(n[m.VirtualCurrency]=
m.Balance,b.VirtualCurrency=n);b.Experience=UpdateExperience("Balancing","BalancingItem","Car_"+k.rarity,l,!0);return generateInventoryChange("InventoryUpdate",b)}d=!1;for(b=0;b<g.Inventory.length;b++)if(g.Inventory[b].ItemId==c.carId&&"CarCards"==g.Inventory[b].CatalogVersion){d=!0;try{if(void 0===g.Inventory[b].CustomData)return generateFailObj("Insufficient cards, CustomData null");if(void 0===g.Inventory[b].CustomData.Amount)return generateFailObj("Insufficient cards, CustomData.Amount null");
if(Number(g.Inventory[b].CustomData.Amount)>=Number(k.cardCostPerLvl[1]))p=g.Inventory[b].ItemInstanceId,g.Inventory[b].CustomData.Amount-=k.cardCostPerLvl[1],n={Amount:g.Inventory[b].CustomData.Amount};else return generateFailObj("Insufficient cards: "+g.Inventory[b].CustomData.Amount+" vs "+k.cardCostPerLvl[1]+".")}catch(u){return generateFailObj("Insufficient cards: "+u)}break}if(0==d)return generateFailObj("No cards found");b=checkBalance(k.currType,k.currCostPerLvl[1],a,f);if("OK"!=b)return b;
h=[];h.push(c.carId);h=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:h});if(!1===h.ItemGrantResults[0].Result)return log.error("Something went wrong while giving user the item, refunding cards"),generateFailObj("Something went wrong while giving user the item, refunding cards.");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:p,Data:n});0<k.currCostPerLvl[1]&&(m=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:k.currType,Amount:k.currCostPerLvl[1]}));b={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:h.ItemGrantResults[0].ItemInstanceId,Data:b});b={TiresLvl:"0",TurboLvl:"0",PaintId:k.defaultPaintID,DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:h.ItemGrantResults[0].ItemInstanceId,Data:b});b={PlatesId:"0",WindshieldId:"0",
Pr:Number(k.basePr)+k.prPerLvl[1]};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:h.ItemGrantResults[0].ItemInstanceId,Data:b});e=h=!1;for(b=0;b<g.Inventory.length;b++)if("PaintJobs"==g.Inventory[b].ItemId){e=!0;void 0!=g.Inventory[b].CustomData?k.defaultPaintID in g.Inventory[b].CustomData?h=!0:(l={},l[k.defaultPaintID]="Owned"):(l={},l[k.defaultPaintID]="Owned");void 0!=l&&server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[b].ItemInstanceId,
Data:l});break}0==e&&(paintToGive=[],paintToGive.push("PaintJobs"),g=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:paintToGive}),l={},l[k.defaultPaintID]="Owned",server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.ItemGrantResults[0].ItemInstanceId,Data:l}));b={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:k.defaultPaintID,DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",
Pr:Number(k.basePr)+k.prPerLvl[1]};c=[{ItemId:c.carId,CatalogVersion:"CarCards",CustomData:n},{ItemId:c.carId,CatalogVersion:"CarsProgress",CustomData:b}];0==h&&(n={},n[k.defaultPaintID]="Owned",c.push({ItemId:"PaintJobs",CatalogVersion:"Customization",CustomData:n}));n={};b={Inventory:c};void 0!=m&&(n[m.VirtualCurrency]=m.Balance,b.VirtualCurrency=n);b.Experience=UpdateExperience("Balancing","BalancingItem","Car_"+k.rarity,1,!0);return generateInventoryChange("InventoryUpdateNewCar",b)}
function upgradePart(c,g,a,f){for(var e=server.GetCatalogItems({CatalogVersion:"CarsProgress"}),d=!1,h=0;h<e.Catalog.length;h++)if(e.Catalog[h].ItemId==c.carId){d=!0;break}if(!1===d)return generateErrObj("car with ID: "+c.carId+" not found in catalog.");for(var e=server.GetCatalogItems({CatalogVersion:"PartCards"}),d=!1,b,h=0;h<e.Catalog.length;h++)if(e.Catalog[h].ItemId==c.partId){b=JSON.parse(e.Catalog[h].CustomData);d=!0;break}if(0==d)return generateErrObj("part with ID: "+c.partId+" not found in catalog.");
for(var d=!1,k,h=0;h<g.Inventory.length;h++)if(g.Inventory[h].ItemId==c.carId&&"CarsProgress"==g.Inventory[h].CatalogVersion){d=!0;k=g.Inventory[h];break}if(!1===d)return generateFailObj("car with ID: "+c.carId+" not found in user inventory.");for(var l=!1,d=0,p={},h=0;h<g.Inventory.length;h++)if(g.Inventory[h].ItemId==c.partId&&"PartCards"==g.Inventory[h].CatalogVersion){var l=!0,n={Exhaust:"ExhaustLvl",Engine:"EngineLvl",Gearbox:"GearboxLvl",Suspension:"SuspensionLvl",Tires:"TiresLvl",Turbo:"TurboLvl"},
d=parseInt(k.CustomData[n[c.partId]])+1;if(d>=Number(b.prPerLvl.length))return generateFailObj("Maximum pr level was reached!");var m=getObjectValueFromLevel(b,"cardCostPerLvl",d),u=getObjectValueFromLevel(b,"currCostPerLvl",d);p[n[c.partId]]=d;k.CustomData[n[c.partId]]=d;var z;a=checkBalance(b.currType,u,a,f);if("OK"!=a)return a;try{if(void 0!==g.Inventory[h].CustomData&&void 0!==g.Inventory[h].CustomData.Amount&&g.Inventory[h].CustomData.Amount>=m)g.Inventory[h].CustomData.Amount-=m,z={Amount:g.Inventory[h].CustomData.Amount},
server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:g.Inventory[h].ItemInstanceId,Data:z});else return generateFailObj("Insufficient cards")}catch(v){return generateFailObj("Insufficient cards")}break}if(0==l)return generateFailObj("Part not found");var r;0<u&&(r=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:b.currType,Amount:u}));h=recalculateCarPr(k.CustomData,k.ItemId,void 0,e);p.Pr=h;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:k.ItemInstanceId,Data:p});k={};h={Inventory:[{ItemId:c.partId,CatalogVersion:"PartCards",CustomData:z},{ItemId:c.carId,CatalogVersion:"CarsProgress",CustomData:p}]};void 0!==r&&(k[r.VirtualCurrency]=r.Balance,h.VirtualCurrency=k);h.Experience=UpdateExperience("Balancing","BalancingItem","Parts_"+b.rarity,d,!0);return generateInventoryChange("InventoryUpdatePart",h)};
