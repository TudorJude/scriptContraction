handlers.endGame=function(b,l){var a="01",d,c="0";"rWin"==b.outcome&&(c="1");var k=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});0!=k.Statistics.length&&(d=k.Statistics[0].Value.toString(),log.debug("wlStatInt "+d),a=Number(d).toString(2),log.debug("wlStat "+a));var k=0,h;log.debug("wlStat.length "+a.length);h=Array(a.length);log.debug("tempString.length "+h.length);for(var f=0;f<h.length-1;f++)h[f]=a[f];h[h.length-1]=c;log.debug("tempString "+h);a=h;log.debug("wlStat "+
a);c=a.length;for(f=0;f<a.length;f++)"1"==a[f]&&k++;log.debug("wlStatNew "+a);h=Math.round(k/c*100);log.debug("winRatio "+h);var e=server.GetTitleData({Key:["LeagueSubdivisions","SubdivisionTrophyRanges"]}),c=0,g,k=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]});0!=k.Statistics.length&&(c=k.Statistics[0].Value,log.debug("getting trophy count "+k.Statistics[0].Value));g=c;"rWin"==b.outcome&&(c=20>c?50:c+60);log.debug("trophies change: "+g+" => "+c);k=calculateLeague(c);
for(f=d=0;f<a.length;f++)"1"==a[f]&&(d+=Math.pow(2,f));f=[];f.push({StatisticName:"WinLoss",Version:"0",Value:d});a={StatisticName:"TrophyCount",Version:"0",Value:c};f.push(a);a={StatisticName:"League",Version:"0",Value:k};f.push(a);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:f});if("rOot"==b.outcome){var m={TrophyCount:c,League:k};return{Result:m}}a=JSON.parse(e.Data.SubdivisionTrophyRanges);log.debug("SubdivisionTrophyRanges "+a);for(f=0;f<a.subdivisions.length;f++)if(g<
a.subdivisions[f]){m=f;break}log.debug("user is in subdivision "+m);f=[];f.push({Key:b.envIndex+"_"+b.courseIndex+"_RecPos",Value:b.recordingPos});f.push({Key:b.envIndex+"_"+b.courseIndex+"_RecRot",Value:b.recordingRot});f.push({Key:b.envIndex+"_"+b.courseIndex+"_RecHeader",Value:b.recordingHeader});log.debug("updating user read only data ");f=server.UpdateUserReadOnlyData({PlayFabId:currentPlayerId,Data:f});log.debug("updated user read only data for "+currentPlayerId+" "+f);f=server.GetTitleInternalData({Key:"RecSubDivision"+
m}).Data["RecSubDivision"+m];log.debug("recPool: "+f);if(void 0==f)a=[],h={wl:h,e:b.envIndex,c:b.courseIndex,uId:currentPlayerId},a.push(h),f=JSON.stringify(a),log.debug("recArray: "+f);else{a=JSON.parse(f);log.debug("recArray: "+a);h={wl:h,e:b.envIndex,c:b.courseIndex,uId:currentPlayerId};e=!1;for(f=g=0;f<a.length;f++)a[f].uId==currentPlayerId&&g++;if(2<g)return m={TrophyCount:c,League:k},{Result:m};for(f=0;f<a.length;f++)if(a[f].e==b.envIndex&&a[f].c==b.courseIndex){e=!0;a[f]=h;if(1==a.length)break;
if(0<f)if(a[f].wl>a[f-1].wl){if(f==a.length-1)break;for(g=f+1;g<a.length;g++)if(a[g-1].wl>a[g].wl)d=a[g],a[g]=a[g-1],a[g-1]=d;else break}else for(g=f-1;0<=g;g--)if(a[g+1].wl<a[g].wl)d=a[g],a[g]=a[g+1],a[g+1]=d;else break;else for(g=f+1;g<a.length;g++)if(a[g-1].wl>a[g].wl)d=a[g],a[g]=a[g-1],a[g-1]=d;else break}0==e&&(log.debug("recArrayLNbefore: "+a.length),a.push(h),log.debug("recArrayLNafter: "+a.length));f=JSON.stringify(a);log.debug("titleKeyVal: "+f)}server.SetTitleInternalData({Key:"RecSubDivision"+
m,Value:f});m={TrophyCount:c,League:k};return{Result:m}};
handlers.startGame=function(b,l){var a="01",d=50,c,k=0;c=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["WinLoss"]});if(0!=c.Statistics.length){a=c.Statistics[0].Value.toString();a=Number(a).toString(2);c=a.length;for(var h=0;h<a.length;h++)"1"==a[h]&&k++;d=Math.round(k/c*100)}log.debug("wlStatBeforeshiftandAdd "+a);a+="0";log.debug("wlStatBeforeshift "+a);20<a.length&&(a=a.slice(1));log.debug("wlStat "+a);c=server.GetTitleData({Key:["LeagueSubdivisions","SubdivisionTrophyRanges",
"TrophyGainRange"]});var f=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]}),k=0;0!=f.Statistics.length&&(k=f.Statistics[0].Value);var f=JSON.parse(c.Data.SubdivisionTrophyRanges),e=JSON.parse(c.Data.LeagueSubdivisions);log.debug("SubdivisionTrophyRanges "+f);for(var g=43,h=0;h<f.subdivisions.length;h++)if(k<f.subdivisions[h]){g=h;break}log.debug("user is in subdivision "+g);var h=server.GetTitleInternalData({Keys:"RecSubDivision"+g}).Data["RecSubDivision"+g],
m=!1;void 0==h&&(m=!0);var r,q;r=0==m?JSON.parse(h):[];var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];log.debug("subrecording pool has "+r.length+" length. Must have: 15 length");15>r.length&&(m=!0);g=Array(r.length);q=0;log.debug("iterating through recArray");for(h=0;h<r.length;h++)1==m&&(n[5*Number(r[h].e)+Number(r[h].c)]=1),r[h].uId==currentPlayerId?log.debug("found: "+r[h].uId+"... skipping"):(g[q]=r[h],q++);log.debug("isIncompleteSubDivision: "+m);if(1==m){for(var t=0,p=0,h=0;h<n.length;h++)if(0==n[h]){t=
Math.floor(h/5);p=h%5;break}log.debug("gettingDefaultUser: env: "+t+" course: "+p);h=server.GetTitleData({Keys:"MasterUser"});if(void 0!=h.Data.MasterUser){log.debug("master user: "+h.Data.MasterUser);var w=server.GetUserReadOnlyData({PlayFabId:h.Data.MasterUser,Keys:[t+"_"+p+"_RecPos",t+"_"+p+"_RecRot",t+"_"+p+"_RecHeader"]});if(void 0!=w.Data&&(log.debug("defaultRecordingData: "+w.Data),void 0!=w.Data[t+"_"+p+"_RecPos"]&&void 0!=w.Data[t+"_"+p+"_RecRot"]&&void 0!=w.Data[t+"_"+p+"_RecHeader"])){k-=
15;0>=k&&(k=0);a=parseInt(a,2);log.debug("updating WL to:  "+a);var v=[],a={StatisticName:"WinLoss",Version:"0",Value:a};v.push(a);a={StatisticName:"TrophyCount",Version:"0",Value:k};v.push(a);a={StatisticName:"League",Version:"0",Value:u};v.push(a);log.debug("updatingStats: "+v);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:v});log.debug("found valid default rec");return{Result:"OK",RecType:"Default",PosData:w.Data[t+"_"+p+"_RecPos"].Value,RotData:w.Data[t+"_"+p+"_RecRot"].Value,
HeaderData:w.Data[t+"_"+p+"_RecHeader"].Value,Opp:"Mniezo"}}}}log.debug("looking for user generated recording");if(0==q)return generateErrObj("no valid recording found for this subdivision");m=q-1;for(h=0;h<q;h++)if(g[h].wl>d){m=h;break}log.debug("pivot is: "+m);d=Math.min(q,3);log.debug("finalRecArraySize: "+d);u=Array(d);for(h=0;h<d;h++)u[h]=0>=m?g[h]:m>=q-1?g[q-1-h]:g[m-Math.floor(d/2)+h];h=Math.floor(Math.random()*d);q=u[h].uId;d=u[h].e;h=u[h].c;u=[d+"_"+h+"_RecPos",d+"_"+h+"_RecRot",d+"_"+h+
"_RecHeader"];log.debug("requesting "+u);g=server.GetUserReadOnlyData({PlayFabId:q,Keys:u});if(void 0==g)return generateErrObj("Did not find recording for this user: "+q);q=server.GetPlayerCombinedInfo({PlayFabId:q,InfoRequestParameters:{GetUserAccountInfo:!0,GetUserInventory:!1,GetUserVirtualCurrency:!1,GetUserData:!1,GetUserReadOnlyData:!1,GetCharacterInventories:!1,GetCharacterList:!1,GetTitleData:!1,GetPlayerStatistics:!1}});var m=k,u=Number(calculateLeague(k));log.debug("lsValParsed: "+e);log.debug("sdvalParsed: "+
f);log.debug("lsValParsed.leagues: "+e.leagues);log.debug("sdvalParsed.subDivisions: "+f.subdivisions);r=0<u?Number(f.subdivisions[e.leagues[u-1]]):0;f=u>=e.leagues.length-1?2*r:Number(f.subdivisions[e.leagues[u]]);log.debug("leagueTitleDataRequest: "+c);log.debug("leagueTitleDataRequest.Data: "+c.Data);log.debug("leagueTitleDataRequest.Data[TrophyGainRange]: "+c.Data.TrophyGainRange);e=c.Data.TrophyGainRange.split("_");c=e[0];e=e[1];t=JSON.parse(w.Data[t+"_"+p+"_RecHeader"].Value);void 0!=t&&(v=
t.Trophies);k-=0>=f-r?e:Math.abs(m-v)<=f-r?c:c+Math.floor((e-c)/2*((m-v)/(f-r)+1));0>=k&&(k=0);a=parseInt(a,2);log.debug("updating WL to:  "+a);v=[];a={StatisticName:"WinLoss",Version:"0",Value:a};v.push(a);a={StatisticName:"TrophyCount",Version:"0",Value:k};v.push(a);a={StatisticName:"League",Version:"0",Value:u};v.push(a);log.debug("updatingStats: "+v);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:v});return{Result:"OK",RecType:"UserGenerated",PosData:g.Data[d+"_"+h+"_RecPos"].Value,
RotData:g.Data[d+"_"+h+"_RecRot"].Value,HeaderData:g.Data[d+"_"+h+"_RecHeader"].Value,Opp:q.InfoResultPayload.AccountInfo.TitleInfo.DisplayName}};
handlers.updateTrophyCount=function(b,l){var a=0,d=server.GetPlayerStatistics({PlayFabId:currentPlayerId,StatisticNames:["TrophyCount"]});0!=d.Statistics.length&&(a=d.Statistics[0].Value);"rStart"==b.val&&(a-=30);0>a&&(a=0);"rWin"==b.val&&(a+=60);if("rLose"==b.val)return{val:a};d=[];d.push({StatisticName:"TrophyCount",Version:"0",Value:a});server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:d});if("rWin"==b.val)return{val:a}};
handlers.initServerData=function(b){b=[];var l={StatisticName:"TrophyCount",Version:"0",Value:"0"};b.push(l);l={StatisticName:"League",Version:"0",Value:"0"};b.push(l);server.UpdatePlayerStatistics({PlayFabId:currentPlayerId,Statistics:b});b=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:["Decals","PaintJobs","Plates","Rims","WindshieldText"]});for(var l={0:"Owned"},a=0;a<b.ItemGrantResults.length;a++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:b.ItemGrantResults[a].ItemInstanceId,Data:l});b=[];b.push("FordFocus");b=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:b});l={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l});l={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l});l={PlatesId:"0",WindshieldId:"0",Pr:"10"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l})};
handlers.requestInventory=function(b){b=server.GetUserInventory({PlayFabId:currentPlayerId});for(var l=server.GetCatalogItems({CatalogVersion:"CarCards"}),a=server.GetCatalogItems({CatalogVersion:"PartCards"}),d=!1,c=0;c<b.Inventory.length;c++)if("CarsProgress"==b.Inventory[c].CatalogVersion){var d=!0,k=checkCarDataValidity(b.Inventory[c],l);log.debug("check "+k);if("PlayFabError"==k||void 0==k)return generateErrObj("PlayfabError");"OK"==k?log.debug("Data for "+b.Inventory[c].ItemId+" OK"):b.Inventory[c].CustomData=
k;b.Inventory[c].CustomData.Pr=recalculateCarPr(b.Inventory[c].CustomData,b.Inventory[c].ItemId,l,a);k={};k.Pr=b.Inventory[c].CustomData.Pr;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.Inventory[c].ItemInstanceId,Data:k})}return 0==d?(b=[],b.push("FordFocus"),b=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:b}),l={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l}),l={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l}),l={PlatesId:"0",WindshieldId:"0",Pr:"10"},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemGrantResults[0].ItemInstanceId,Data:l}),generateErrObj("UserHasNoCars ... reiniting")):b};
function checkCarDataValidity(b,l){if(void 0==b.CustomData){try{var a={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemInstanceId,Data:a});a={TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemInstanceId,Data:a});for(var d=0,c=0;c<l.Catalog.length;c++)if(l.Catalog[c].ItemId==b.ItemId){var k=
JSON.parse(l.Catalog[c].CustomData),d=parseInt(k.basePr);break}a={PlatesId:"0",WindshieldId:"0",Pr:d};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:b.ItemInstanceId,Data:a})}catch(h){return"PlayFabError"}return{CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:"0",DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",Pr:d}}return"OK"}function generateFailObj(b){return{Result:"Failed",Message:b}}
function generateErrObj(b){return{Result:"Error",Message:b}}function checkBalance(b,l,a,d){if("SC"==b){if(a<l)return generateFailObj("NotEnoughSC")}else if(d<l)return generateFailObj("NotEnoughHC");return"OK"}
function calculateLeague(b){var l=server.GetTitleData({Keys:["LeagueSubdivisions","SubdivisionTrophyRanges"]});if(void 0==l.Data.LeagueSubdivisions||void 0==l.Data.SubdivisionTrophyRanges)return 1;for(var a=JSON.parse(l.Data.LeagueSubdivisions).leagues,l=JSON.parse(l.Data.SubdivisionTrophyRanges).subdivisions,d=0;d<a.length;d++)if(!(Number(b)>Number(l[a[d]])))return d}
function recalculateCarPr(b,l,a,d){var c=0,k;k=void 0==a?server.GetCatalogItems({CatalogVersion:"CarCards"}):a;for(a=0;a<k.Catalog.length;a++)if(k.Catalog[a].ItemId==l){a=JSON.parse(k.Catalog[a].CustomData);c+=parseInt(a.basePr)+parseInt(a.prPerLvl)*(parseInt(b.CarLvl)-1);break}d=void 0==d?server.GetCatalogItems({CatalogVersion:"PartCards"}):d;b={Exhaust:b.ExhaustLvl,Engine:b.EngineLvl,Gearbox:b.GearboxLvl,Suspension:b.SuspensionLvl,Tires:b.TiresLvl,Turbo:b.TurboLvl};for(a=0;a<d.Catalog.length;a++)l=
JSON.parse(d.Catalog[a].CustomData),c+=parseInt(l.basePr)+parseInt(l.prPerLvl)*b[d.Catalog[a].ItemId];return c}
function GenerateBlackMarket(b){var l=1,a=server.GetPlayerStatistics({PlayFabId:b,StatisticNames:["League"]});0!=a.Statistics.length&&(l=a.Statistics[0].Value.toString());var d=server.GetCatalogItems({CatalogVersion:"PartCards"}),a={};a.BMTime=(new Date).getTime();var c=Math.floor(Math.random()*d.Catalog.length),k=JSON.parse(d.Catalog[c].CustomData);if(void 0==k)return generateErrObj("Part card "+d.Catalog[f].ItemId+" has no custom data.");a.BMItem0=d.Catalog[c].ItemId+"_"+k.BMCurrType+"_"+k.BMbasePrice+
"_0_"+k.BMpriceIncrPerBuy;var h=Math.floor(Math.random()*d.Catalog.length);h==c&&(h=d.Catalog.length-c-1);k=JSON.parse(d.Catalog[h].CustomData);if(void 0==k)return generateErrObj("Part card "+d.Catalog[f].ItemId+" has no custom data.");a.BMItem1=d.Catalog[h].ItemId+"_"+k.BMCurrType+"_"+k.BMbasePrice+"_0_"+k.BMpriceIncrPerBuy;for(var d=server.GetCatalogItems({CatalogVersion:"CarCards"}),k=[],h=[],f=0;f<d.Catalog.length;f++){c=JSON.parse(d.Catalog[f].CustomData);if(void 0==c)return generateErrObj("Car card "+
d.Catalog[f].ItemId+" has no custom data.");c.unlockedAtRank>l+1||("false"==c.rareCar?k.push(d.Catalog[f].ItemId+"_"+c.BMCurrType+"_"+c.BMbasePrice+"_0_"+c.BMpriceIncrPerBuy):h.push(d.Catalog[f].ItemId+"_"+c.BMCurrType+"_"+c.BMbasePrice+"_0_"+c.BMpriceIncrPerBuy))}0>=k.length?(a.BMItem2=h[Math.floor(Math.random()*h.length)],a.BMItem3=h[Math.floor(Math.random()*h.length)]):0>=h.length?(a.BMItem2=k[Math.floor(Math.random()*k.length)],a.BMItem3=k[Math.floor(Math.random()*k.length)]):(a.BMItem2=k[Math.floor(Math.random()*
k.length)],a.BMItem3=h[Math.floor(Math.random()*h.length)]);server.UpdateUserInternalData({PlayFabId:b,Data:a});l=[];l.push("BlackMarketResetMinutes");b=server.GetTitleData({PlayFabId:b,Keys:l});a.BMTime=60*parseInt(b.Data.BlackMarketResetMinutes);return a}
function GetCurrentBlackMarket(b,l){var a={},d=new Date,c=[];c.push("BlackMarketResetMinutes");c=server.GetTitleData({PlayFabId:b,Keys:c});a.BMTime=60*parseInt(c.Data.BlackMarketResetMinutes)-Math.floor((d.getTime()-l.Data.BMTime.Value)/1E3);for(d=0;4>d;d++)a["BMItem"+d]=l.Data["BMItem"+d].Value;return a}
handlers.purchaseBMItem=function(b,l){log.debug("purchasing item "+b.itemId+" from black market");if(0>b.itemId||3<b.itemId)return generateFailObj("invalid item index");var a=[];a.push("BMItem"+b.itemId);var a=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:a}),d=server.GetUserInventory({PlayFabId:currentPlayerId}),a=a.Data["BMItem"+b.itemId].Value.split("_");log.debug("userArray: "+a);var c=d.VirtualCurrency[a[1]];5!=a.length&&generateErrObj("User Black Market corrupted. Try again tomorrow");
var k;k=2>b.itemId?"PartCards":"CarCards";var h=parseInt(a[2])+parseInt(a[3])*parseInt(a[4]),c=checkBalance(a[1],h,c,c);if("OK"!=c)return c;var f,e;log.debug("searching for: "+a[0]+" in "+k);for(c=0;c<d.Inventory.length;c++)if(d.Inventory[c].ItemId==a[0]&&d.Inventory[c].CatalogVersion==k){log.debug("found it!");f=d.Inventory[c].ItemInstanceId;void 0==d.Inventory[c].CustomData?(log.debug("no custom data. creating ..."),e={Amount:1}):void 0==d.Inventory[c].CustomData.Amount?e={Amount:1}:(e=Number(d.Inventory[c].CustomData.Amount)+
1,isNaN(e)&&(e=1),e={Amount:e});server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:f,Data:e});break}void 0==f&&(log.debug("cardInstance is undefined"),f=[],f.push(a[0]),f=server.GrantItemsToUser({CatalogVersion:k,PlayFabId:currentPlayerId,ItemIds:f}).ItemGrantResults[0].ItemInstanceId,void 0==f?generateErrObj("grantRequest denied"):(e={Amount:1},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:f,Data:e})));f=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:a[1],Amount:h});h=a[0]+"_"+a[1]+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];log.debug("generatedArray: "+h);d={};d["BMItem"+b.itemId]=h;server.UpdateUserInternalData({PlayFabId:currentPlayerId,Data:d});e=[{ItemId:a[0],CatalogVersion:k,CustomData:e}];k={};k[f.VirtualCurrency]=f.Balance;a=b.itemId+"_"+a[2]+"_"+(parseInt(a[3])+1)+"_"+a[4];c={Inventory:e,VirtualCurrency:k};return{Result:"OK",Message:"InventoryUpdate",InventoryChange:c,BMItemChange:a}};
handlers.retrieveBlackMarket=function(b,l){var a=[];a.push("BMTime");for(var d=0;4>d;d++)a.push("BMItem"+d);a=server.GetUserInternalData({PlayFabId:currentPlayerId,Keys:a});if(void 0==a.Data.BMTime)return log.debug("No user BM data detected; generating ..."),GenerateBlackMarket(currentPlayerId);d=new Date;log.debug("milliseconds passed: "+d.getTime());log.debug("BMTime: "+a.Data.BMTime.Value);var c=[];c.push("BlackMarketResetMinutes");c=server.GetTitleData({PlayFabId:currentPlayerId,Keys:c});if(1==
b.reset){log.debug("reseting market");a="HC";d=200;c=server.GetTitleData({Keys:["BlackMarketResetCost"]});void 0!=c.Data.BlackMarketResetCost&&(d=c.Data.BlackMarketResetCost.split("_"),a=d[0],d=Number(d[1]));if(0<d){c=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(a,d,c.VirtualCurrency.SC,c.VirtualCurrency.HC))return generateFailObj("not enough money");d=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:a,Amount:d});a=GenerateBlackMarket(currentPlayerId);
c={};c[d.VirtualCurrency]=d.Balance;d={VirtualCurrency:c};a.InventoryChange=d;return a}return GenerateBlackMarket(currentPlayerId)}if(d.getTime()-parseInt(a.Data.BMTime.Value)>6E4*parseInt(c.Data.BlackMarketResetMinutes))return log.debug("regenerating market"),GenerateBlackMarket(currentPlayerId);log.debug("get current market");return GetCurrentBlackMarket(currentPlayerId,a)};
handlers.updateCarCust=function(b,l){for(var a=server.GetUserInventory({PlayFabId:currentPlayerId}),d=[],c="-1",k={},h={PaintJobs:{itemOwned:"no",itemCustData:b.paintId,carItemId:"PaintId"},Decals:{itemOwned:"no",itemCustData:b.decalId,carItemId:"DecalId"},Plates:{itemOwned:"no",itemCustData:b.platesId,carItemId:"PlatesId"},Rims:{itemOwned:"no",itemCustData:b.rimsId,carItemId:"RimsId"},WindshieldText:{itemOwned:"no",itemCustData:b.wsId,carItemId:"WindshieldId"}},f=0;f<a.Inventory.length;f++)a.Inventory[f].ItemId==
b.carId&&"CarsProgress"==a.Inventory[f].CatalogVersion&&(c=a.Inventory[f].ItemInstanceId),a.Inventory[f].ItemId in h&&(h[a.Inventory[f].ItemId].itemOwned="yes",h[a.Inventory[f].ItemId].itemCustData in a.Inventory[f].CustomData?k[h[a.Inventory[f].ItemId].carItemId]=h[a.Inventory[f].ItemId].itemCustData:log.debug("user doesn't own: "+a.Inventory[f].ItemId+" "+h[a.Inventory[f].ItemId].itemCustData));if("-1"==c)return generateFailObj("User does not own car with id: "+b.carId);for(var e in h)h.hasOwnProperty(e)&&
"no"==h[e].itemOwned&&d.push(e);if(k=={})return generateFailObj("User doesn't own any of those customizations");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c,Data:k});a=[{ItemId:b.carId,CatalogVersion:"CarsProgress",CustomData:k}];if(0<d.length)for(d=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:d}),c={0:"Owned"},f=0;f<d.ItemGrantResults.length;f++)server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:d.ItemGrantResults[f].ItemInstanceId,Data:c});return{Result:"OK",Message:"InventoryUpdate",InventoryChange:{Inventory:a}}};
handlers.purchaseItems=function(b,l){log.debug("RETRIEVING USER INVENTORY");var a=server.GetUserInventory({PlayFabId:currentPlayerId}),d=a.VirtualCurrency.SC,c=a.VirtualCurrency.HC;log.debug("user currency: SC: "+d+" HC: "+c);switch(b.purchaseType){case "carUpgrade":log.debug("== carUpgrade request: carId: "+b.carId);log.debug("RETRIEVING CARDS CATALOGUE");for(var k=server.GetCatalogItems({CatalogVersion:"CarCards"}),h=!1,f,e=0;e<a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.carId&&"CarsProgress"==
a.Inventory[e].CatalogVersion){h=!0;log.debug("car is in user's inventory!");f=a.Inventory[e];break}for(var g,e=0;e<k.Catalog.length;e++)if(k.Catalog[e].ItemId==b.carId){g=JSON.parse(k.Catalog[e].CustomData);log.debug("cardInfo found!");break}if(void 0==g)return log.error("cardInfo undefined!"),g={Result:"Error",Message:"CardNotFoundForCarwithID: "+b.carId+". It is possible that the carCard ID and the Car ID do not coincide. Check Playfab catalog data."};if(1==h){log.debug("user has car: "+b.carId+
"... upgrading");var m=parseInt(f.CustomData.CarLvl)+1,r=parseInt(g.baseCurrCost)+m*parseInt(g.currCostPerLvl),c=checkBalance(g.currType,r,d,c);if("OK"!=c)return c;log.debug("user has enough currency. Let's check for card balance");c=parseInt(g.baseCardCost)+parseInt(f.CustomData.CarLvl)*parseInt(g.cardCostPerLvl);log.debug("cardCost: "+c);for(var h=!1,q,e=0;e<a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.carId&&"CarCards"==a.Inventory[e].CatalogVersion){log.debug("consuming: "+a.Inventory[e].ItemInstanceId);
h=!0;try{if(void 0==a.Inventory[e].CustomData)return generateFailObj("Insufficient cards, CusotmData undefined");if(void 0==a.Inventory[e].CustomData.Amount)return generateFailObj("Insufficient cards, CusotmData.Amount udnefined");if(Number(a.Inventory[e].CustomData.Amount)>=c)a.Inventory[e].CustomData.Amount-=c,q={Amount:a.Inventory[e].CustomData.Amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[e].ItemInstanceId,Data:q});else return generateFailObj("Insufficient cards for real: "+
a.Inventory[e].CustomData.Amount+" vs "+c)}catch(u){return log.debug("itemConsumptionResult.errorCode "+u),generateFailObj("Insufficient cards")}break}if(0==h)return generateFailObj("No cards found");log.debug("user has enough cards to purchase upgrade!");a=recalculateCarPr(f.CustomData,f.ItemId,k,void 0);log.debug("upgrading to car lvl: "+m+" and pr: "+a);e={CarLvl:m,Pr:a};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:f.ItemInstanceId,Data:e});var n;0<r&&(n=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,
VirtualCurrency:g.currType,Amount:r}));log.debug("Upgrade Complete!");a=[{ItemId:b.carId,CatalogVersion:"CarCards",CustomData:q},{ItemId:b.carId,CatalogVersion:"CarsProgress",CustomData:e}];g={};e={Inventory:a};void 0!=n&&(g[n.VirtualCurrency]=n.Balance,e.VirtualCurrency=g);g={Result:"OK",Message:"InventoryUpdate",InventoryChange:e}}else{log.debug("user doesn't have car: "+b.carId+"... looking for card");for(var h=!1,t,e=0;e<a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.carId&&"CarCards"==a.Inventory[e].CatalogVersion){log.debug("consuming: "+
a.Inventory[e].ItemInstanceId);h=!0;try{if(void 0==a.Inventory[e].CustomData)return generateFailObj("Insufficient cards, CustomData null");if(void 0==a.Inventory[e].CustomData.Amount)return generateFailObj("Insufficient cards, CustomData.Amount null");if(Number(a.Inventory[e].CustomData.Amount)>=Number(g.baseCardCost))t=a.Inventory[e].ItemInstanceId,a.Inventory[e].CustomData.Amount-=g.baseCardCost,q={Amount:a.Inventory[e].CustomData.Amount};else return generateFailObj("Insufficient cards: "+a.Inventory[e].CustomData.Amount+
" vs "+g.baseCardCost+".")}catch(u){return generateFailObj("Insufficient cards: "+u)}break}if(0==h)return generateFailObj("No cards found");log.debug("user has enough cards to purchase car. Checking if enough currency is availabe");c=checkBalance(g.currType,g.baseCurrCost,d,c);if("OK"!=c)return c;e=[];e.push(b.carId);c=server.GrantItemsToUser({CatalogVersion:"CarsProgress",PlayFabId:currentPlayerId,ItemIds:e});if(0==c.ItemGrantResults[0].Result)return log.error("Something went wrong while giving user the item, refunding cards"),
generateFailObj("Something went wrong while giving user the item, refunding cards.");server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:t,Data:q});0<g.baseCurrCost&&(n=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:g.currType,Amount:g.baseCurrCost}));e={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,
Data:e});e={TiresLvl:"0",TurboLvl:"0",PaintId:g.defaultPaintID,DecalId:"0",RimsId:"0"};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:e});e={PlatesId:"0",WindshieldId:"0",Pr:g.basePr};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:c.ItemGrantResults[0].ItemInstanceId,Data:e});for(var d=c=!1,p,e=0;e<a.Inventory.length;e++)if("PaintJobs"==a.Inventory[e].ItemId){d=!0;log.debug("user has paintjobs");
void 0!=a.Inventory[e].CustomData?(log.debug("user has paintjobs customData"),g.defaultPaintID in a.Inventory[e].CustomData?(log.debug("user has paintjob already"),c=!0):(log.debug("user doesn't have paintjob"),p={},p[g.defaultPaintID]="Owned")):(p={},p[g.defaultPaintID]="Owned");void 0!=p&&server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[e].ItemInstanceId,Data:p});break}0==d&&(paintToGive=[],paintToGive.push("PaintJobs"),a=server.GrantItemsToUser({CatalogVersion:"Customization",
PlayFabId:currentPlayerId,ItemIds:paintToGive}),p={},p[g.defaultPaintID]="Owned",server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.ItemGrantResults[0].ItemInstanceId,Data:p}));e={CarLvl:"1",EngineLvl:"0",ExhaustLvl:"0",GearboxLvl:"0",SuspensionLvl:"0",TiresLvl:"0",TurboLvl:"0",PaintId:g.defaultPaintID,DecalId:"0",RimsId:"0",PlatesId:"0",WindshieldId:"0",Pr:g.basePr};a=[{ItemId:b.carId,CatalogVersion:"CarCards",CustomData:q},{ItemId:b.carId,CatalogVersion:"CarsProgress",
CustomData:e}];0==c&&(e={},e[g.defaultPaintID]="Owned",a.push({ItemId:"PaintJobs",CatalogVersion:"Customization",CustomData:e}));g={};e={Inventory:a};void 0!=n&&(g[n.VirtualCurrency]=n.Balance,e.VirtualCurrency=g);g={Result:"OK",Message:"InventoryUpdateNewCar",InventoryChange:e}}return g;case "partUpgrade":log.debug("Upgrading Part: "+b.partId+" on Car: "+b.carId);log.debug("Checking to see if car exists in catalog");q=server.GetCatalogItems({CatalogVersion:"CarsProgress"});p=!1;for(e=0;e<q.Catalog.length;e++)if(q.Catalog[e].ItemId==
b.carId){p=!0;break}if(0==p)return log.error("invalid car ID"),g={Result:"Error",Message:"car with ID: "+b.carId+" not found in catalog."};log.debug("Checking to see if part exists in catalog");q=server.GetCatalogItems({CatalogVersion:"PartCards"});p=!1;for(e=0;e<q.Catalog.length;e++)if(q.Catalog[e].ItemId==b.partId){g=JSON.parse(q.Catalog[e].CustomData);p=!0;break}if(0==p)return log.error("invalid part ID"),g={Result:"Error",Message:"part with ID: "+b.partId+" not found in catalog."};log.debug("Checking to see if user has car: "+
b.carId);h=!1;for(e=0;e<a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.carId&&"CarsProgress"==a.Inventory[e].CatalogVersion){h=!0;log.debug("car is in user's inventory!");f=a.Inventory[e];break}if(0==h)return generateFailObj("car with ID: "+b.carId+" not found in user inventory.");log.debug("Checking to see if user has part and or has enough parts");p=!1;for(e=0;e<a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.partId&&"PartCards"==a.Inventory[e].CatalogVersion){p=!0;log.debug("part is in user's inventory!");
k={};h={Exhaust:"ExhaustLvl",Engine:"EngineLvl",Gearbox:"GearboxLvl",Suspension:"SuspensionLvl",Tires:"TiresLvl",Turbo:"TurboLvl"};log.debug("calculating "+b.partId+" cost and modifying "+h[b.partId]);t=parseInt(g.baseCardCost,10)+parseInt(f.CustomData[h[b.partId]],10)*parseInt(g.cardCostPerLvl,10);var w=parseInt(f.CustomData[h[b.partId]])+1,r=Number(g.baseCurrCost)+w*Number(g.currCostPerLvl);k[h[b.partId]]=w;f.CustomData[h[b.partId]]=w;log.debug("we need: "+t+" cards and "+r+" money => base: "+parseInt(g.baseCurrCost)+
" lvls: "+parseInt(f.CustomData[h[b.partId]])+" perLvlCost: "+parseInt(g.currCostPerLvl)+" equalling: "+parseInt(f.CustomData[h[b.partId]],10)*parseInt(g.currCostPerLvl,10));c=checkBalance(g.currType,r,d,c);if("OK"!=c)return c;log.debug("consuming part instance: "+a.Inventory[e].ItemInstanceId);try{if(void 0!=a.Inventory[e].CustomData&&void 0!=a.Inventory[e].CustomData.Amount&&a.Inventory[e].CustomData.Amount>=t)a.Inventory[e].CustomData.Amount-=t,m={Amount:a.Inventory[e].CustomData.Amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:a.Inventory[e].ItemInstanceId,Data:m});else return generateFailObj("Insufficient cards")}catch(u){return log.debug("itemConsumptionResult.errorCode "+u),generateFailObj("Insufficient cards")}break}if(0==p)return generateFailObj("Part not found");0<r&&(n=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:g.currType,Amount:r}));a=recalculateCarPr(f.CustomData,f.ItemId,void 0,q);k.Pr=a;server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:f.ItemInstanceId,
Data:k});a=[{ItemId:b.partId,CatalogVersion:"PartCards",CustomData:m},{ItemId:b.carId,CatalogVersion:"CarsProgress",CustomData:k}];log.debug("succesfully upgraded part!");g={};e={Inventory:a};void 0!=n&&(g[n.VirtualCurrency]=n.Balance,e.VirtualCurrency=g);return g={Result:"OK",Message:"InventoryUpdatePart",InventoryChange:e};case "custPurchase":log.debug("Purchasing Customization: "+b.custId+" with val: "+b.custVal);log.debug("Checking to see if customization exists in catalog");f=server.GetCatalogItems({CatalogVersion:"Customization"});
g=0;n="SC";for(e=0;e<f.Catalog.length;e++)if(f.Catalog[e].ItemId==b.custId){w=f.Catalog[e];g=JSON.parse(f.Catalog[e].CustomData);e=b.custVal+",Cost";n=g[b.custVal+",Curr"];g=g[e];c=checkBalance(n,g,d,c);if("OK"!=c)return c;log.debug("custCurr: "+n);log.debug("custPrice: "+g);break}if(void 0==w)return log.error("Customization does not exist in catalog"),g={Result:"Error",Message:"Customization does not exist in catalog."};log.debug("Checking to see if user has said customization");for(var v,e=0;e<
a.Inventory.length;e++)if(a.Inventory[e].ItemId==b.custId){log.debug("user has customization category!");v=a.Inventory[e];h=a.Inventory[e].ItemInstanceId;if(void 0!=v.CustomData&&String(b.custVal)in v.CustomData)return generateFailObj("User already has this customization.");break}if(void 0==v){log.info("user doesn't have customization category. Granting ... ");e=[];e.push(b.custId);a=server.GrantItemsToUser({CatalogVersion:"Customization",PlayFabId:currentPlayerId,ItemIds:e});if(0==a.ItemGrantResults[0].Result)return log.error("something went wrong while granting user customization class object"),
g={Result:"Error",Message:"something went wrong while granting user customization class object."};h=a.ItemGrantResults[0].ItemInstanceId}a={};a[String(b.custVal)]="Owned";server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:h,Data:a});a=[{ItemId:b.custId,CatalogVersion:"Customization",CustomData:a}];0<g?(n=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:n,Amount:g}),g={},g[n.VirtualCurrency]=n.Balance,e={Inventory:a,VirtualCurrency:g}):e=
{Inventory:a};return g={Result:"OK",Message:"InventoryUpdateNewCustomization",InventoryChange:e};case "softCurrencyPurchase":log.debug("Purchasing pack: "+b.packId);log.debug("Checking to see if pack exists in catalog");n=server.GetCatalogItems({CatalogVersion:"SoftCurrencyStore"});a=!1;for(e=d=0;e<n.Catalog.length;e++)if(n.Catalog[e].ItemId==b.packId){d=n.Catalog[e].VirtualCurrencyPrices.HC;g=JSON.parse(n.Catalog[e].CustomData);a=!0;break}if(0==a)return g={Result:"Error",Message:"pack with ID: "+
b.packId+" not found in catalog."};if(0>=d)return g={Result:"Error",Message:"pack with ID: "+b.packId+" shouldn't have negative cost."};if(d>c)return generateFailObj("Not enough HC.");n=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"HC",Amount:d});a=server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:"SC",Amount:g.quantity});g={};g[a.VirtualCurrency]=a.Balance;g[n.VirtualCurrency]=n.Balance;return g={Result:"OK",Message:"SoftCurrencyPurchased",
InventoryChange:{VirtualCurrency:g}};default:log.debug("invalid purchase parameter")}};handlers.giveMoney=function(b){b=server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:b.curr,Amount:b.amount});var l={};l[b.VirtualCurrency]=b.Balance;return{Result:"OK",Message:"CurrencyChanged",InventoryChange:{VirtualCurrency:l}}};
handlers.grantItems=function(b){for(var l=server.GetUserInventory({PlayFabId:currentPlayerId}),a,d=!1,c=0;c<l.Inventory.length;c++)if(l.Inventory[c].ItemId==b.itemId&&l.Inventory[c].CatalogVersion==b.catalogId){log.debug("adding amount to: "+l.Inventory[c].ItemInstanceId);a=void 0==l.Inventory[c].CustomData?b.amount:void 0==l.Inventory[c].CustomData.Amount?b.amount:isNaN(Number(l.Inventory[c].CustomData.Amount))?b.amount:Number(l.Inventory[c].CustomData.Amount)+b.amount;a={Amount:a};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,
ItemInstanceId:l.Inventory[c].ItemInstanceId,Data:a});d=!0;break}0==d&&(l=[],l.push(b.itemId),l=server.GrantItemsToUser({CatalogVersion:b.catalogId,PlayFabId:currentPlayerId,ItemIds:l}),a={Amount:b.amount},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:l.ItemGrantResults[0].ItemInstanceId,Data:a}));return{Result:"OK",Message:"InventoryUpdated",InventoryChange:{Inventory:[{ItemId:b.itemId,CatalogVersion:b.catalogId,CustomData:a}]}}};
handlers.openChest=function(b,l){var a=server.GetUserInventory({PlayFabId:currentPlayerId});if(0<b.currCost){if("OK"!=checkBalance(b.currType,b.currCost,a.VirtualCurrency.SC,a.VirtualCurrency.HC))return generateFailObj("not enough money");server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:b.currType,Amount:b.currCost})}for(var d in b.currencyReq)0<b.currencyReq[d]&&server.AddUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:d,Amount:b.currencyReq[d]});var c;
for(d in b.carCardsRequest)if(log.debug(d+" : "+b.carCardsRequest[d]),b.carCardsRequest.hasOwnProperty(d)){c=!1;log.debug("looking for: "+d);for(var k=0;k<a.Inventory.length;k++)if(a.Inventory[k].ItemId==d&&"CarCards"==a.Inventory[k].CatalogVersion){log.debug("adding amount to: "+a.Inventory[k].ItemInstanceId);c=void 0==a.Inventory[k].CustomData?Number(b.carCardsRequest[d]):void 0==a.Inventory[k].CustomData.Amount?Number(b.carCardsRequest[d]):isNaN(Number(a.Inventory[k].CustomData.Amount))?Number(b.carCardsRequest[d]):
Number(a.Inventory[k].CustomData.Amount)+Number(b.carCardsRequest[d]);c={Amount:c};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[k].ItemInstanceId,Data:c});c=!0;break}0==c&&(k=[d],k=server.GrantItemsToUser({CatalogVersion:"CarCards",PlayFabId:currentPlayerId,ItemIds:k}),c={Amount:b.carCardsRequest[d]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemGrantResults[0].ItemInstanceId,Data:c}))}for(d in b.partCardsRequest)if(log.debug(d+
" : "+b.partCardsRequest[d]),b.partCardsRequest.hasOwnProperty(d)){c=!1;log.debug("looking for: "+d);for(k=0;k<a.Inventory.length;k++)if(a.Inventory[k].ItemId==d&&"PartCards"==a.Inventory[k].CatalogVersion){log.debug("adding amount to: "+a.Inventory[k].ItemInstanceId);c=void 0==a.Inventory[k].CustomData?Number(b.partCardsRequest[d]):void 0==a.Inventory[k].CustomData.Amount?Number(b.partCardsRequest[d]):isNaN(Number(a.Inventory[k].CustomData.Amount))?Number(b.partCardsRequest[d]):Number(a.Inventory[k].CustomData.Amount)+
Number(b.partCardsRequest[d]);c={Amount:c};server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:a.Inventory[k].ItemInstanceId,Data:c});c=!0;break}0==c&&(k=[d],k=server.GrantItemsToUser({CatalogVersion:"PartCards",PlayFabId:currentPlayerId,ItemIds:k}),c={Amount:b.partCardsRequest[d]},server.UpdateUserInventoryItemCustomData({PlayFabId:currentPlayerId,ItemInstanceId:k.ItemGrantResults[0].ItemInstanceId,Data:c}))}return{Result:"OK",Message:"InventoryUpdated",InventoryChange:server.GetUserInventory({PlayFabId:currentPlayerId})}};
handlers.buyChest=function(b,l){var a=server.GetUserInventory({PlayFabId:currentPlayerId});if("OK"!=checkBalance(b.curr,b.cost,a.VirtualCurrency.SC,a.VirtualCurrency.HC))return generateFailObj("not enough money");if(0<b.cost){var a=server.SubtractUserVirtualCurrency({PlayFabId:currentPlayerId,VirtualCurrency:b.curr,Amount:b.cost}),d={};d[a.VirtualCurrency]=a.Balance;return{Result:"OK",Message:"ChestBought",InventoryChange:{VirtualCurrency:d}}}return{Result:"OK",Message:"ChestBought",InventoryChange:{}}};
handlers.getServerTime=function(b,l){return{time:new Date}};
